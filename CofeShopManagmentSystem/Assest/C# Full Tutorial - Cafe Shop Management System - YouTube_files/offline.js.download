(function(g){var window=this;'use strict';var I_=function(k,U,n){return k.S.objectStore("EntityStore").get(U).then(Z=>{if(Z){if(n&&Z.entityType!==n)throw Error("Incorrect entity type");return g.zT(k,Z)}})},qm=function(k,U,n){return n?(n=n.map(Z=>I_(k,Z,U)),g.Wi.all(n)):k.S.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(U)).then(Z=>Z.map(C=>g.zT(k,C)))},J4=function(k,U,n){U=U.map(Z=>g.TT(k,Z,n));
return g.Wi.all(U)},xzb=function(k,U){const n=k.S.objectStore("EntityAssociationStore");
return n.index("byParentEntityKey").getAll(IDBKeyRange.only(U)).then(Z=>{const C=[];for(const r of Z)C.push(n.index("byChildEntityKey").getAll(r.childEntityKey));return g.Wi.all(C)}).then(Z=>{const C=[];
for(const r of Z)r.length===1&&C.push(r[0].childEntityKey);return C})},k6E=function(k,U,n){if(n.has(U))return g.Wi.resolve(void 0);
n.add(U);return xzb(k,U).then(Z=>k.S.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(U)).then(()=>Z)).then(Z=>{let C=g.Wi.resolve(void 0);
for(const r of Z)C=C.then(()=>k6E(k,r,n));
return C}).then(()=>{})},e1=function(k,U,n){if(n?.qg){const C=new Set;
return k6E(k,U,C).then(()=>{const r=[];for(const L of C)r.push(e1(k,L));return g.Wi.all(r).then(()=>{})})}const Z=g.Zd(U).entityType;
return g.Wi.all([k.S.objectStore("EntityStore").delete(U),g.QW(k,U)]).then(()=>{g.Kd(k,U,Z)})},BD=function(k,U){return g.US(k.S.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(U)},n=>g.Wi.all([n.delete(),
g.QW(k,n.cursor.primaryKey)]).then(()=>{g.Kd(k,n.cursor.primaryKey,U);return g.ih(n)}))},iG_=function(k,U,n,Z){const C=g.br(k.B,1);
return I_(k,U,Z).then(r=>{if(r){r=g.hG(r,n);var L={key:U,entityType:Z,data:g.JVO(C,r,U),version:1};return g.Wi.all([k.S.objectStore("EntityStore").put(L),g.shJ(k,r,Z)])}}).then(()=>{g.Kd(k,U,Z);
return U})},UdV=function(k,U){return g.ar(k,{mode:"readwrite",
TQ:!0},n=>J4(n,U,"offlineOrchestrationActionWrapperEntity"))},PD=function(k,U){return g.ar(k,{mode:"readwrite",
TQ:!0},n=>e1(n,U))},nTE=function(k){return g.ar(k,{mode:"readwrite",
TQ:!0},U=>BD(U,"videoPlaybackPositionEntity"))},Y7=function(k,U,n){return g.ar(k,{mode:"readonly",
TQ:!0},Z=>I_(Z,U,n))},D6=function(k,U,n){return g.ar(k,{mode:"readonly",
TQ:!0},Z=>qm(Z,U,n))},ZG7=function(k){const U=new g.P2("und",new g.Eo("Default","und",!0));
U.captionTracks=k.captionTracks;return U},CKV=function(k){return new g.Wz(function(U,n){let Z=k.length;
const C=[];if(Z){var r=function(v,O){Z--;C[v]=O;Z==0&&U(C)},L=function(v){n(v)};
for(let v=0;v<k.length;v++){var F=k[v];g.lc(F,g.N6(r,v),L)}}else U(C)})},r22=function({type:k,
payload:U}){k={type:k};U!==void 0&&(k.payload=U);return k},o_=function(k){return g.ZA((0,g.LoB)(),k)},LrY=function(k){k=k.options?.persistenceOption;
return k==="ENTITY_PERSISTENCE_OPTION_PERSIST"||k==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},Frs=async function(k){const U=await g.Nj();
U&&await g.ar(U,"readwrite",n=>{const Z={};for(const C of k){if(!C.entityKey||!LrY(C))continue;const r=g.B7(C.payload);let L=void 0;C.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(L=()=>g.TT(n,C.payload[r],r));
C.type==="ENTITY_MUTATION_TYPE_DELETE"&&(L=()=>e1(n,C.entityKey));
C.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(L=()=>iG_(n,C.entityKey,C.payload[r],r));
L&&(Z[C.entityKey]=Z[C.entityKey]?Z[C.entityKey].then(L):L())}return g.Wi.all(Object.values(Z))})},WD=async function(k){!(k=k.mutations)||k.length<=0||(g.h$&&g.h$.dispatch(r22({type:"ENTITY_LOADED",
payload:k})),await Frs(k),k.length=0)},vT7=function(k){return k!==void 0},OG2=function(k){var U=g.iT();
U=Object.assign({},U);k=Object.assign({},k);for(const n in U)k[n]?(U[n]!==4&&(U[n]=k[n]),delete k[n]):U[n]!==2&&(U[n]=4);Object.assign(U,k);g.mjz(U);JSON.stringify(U);return U},wIY=async function(k){const U=await g.uh();
return U?g.y6(await g.Zy(U),["index","media","captions"],{mode:"readwrite",TQ:!0},n=>{const Z=IDBKeyRange.bound(k+"|",k+"~");n=[n.objectStore("index").delete(Z),n.objectStore("media").delete(Z),n.objectStore("captions").delete(Z)];return g.Wi.all(n).then(()=>{})}):void 0},ufs=async function(){const k=await g.uh();
if(!k)throw g.oU("rvdfd");return g.y6(await g.Zy(k),["index","media"],{mode:"readwrite",TQ:!0},U=>{const n={};return g.kI(U.objectStore("index"),{},Z=>{var C=Z.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let r=g.Wi.resolve(void 0);if(C){const L=C[1];C=C[2];n[L]=n[L]||{};n[L][C]=g.U26(Z.getValue()?.fmts)}else r=Z.delete().then(()=>{});
return g.Wi.all([g.ih(Z),r]).then(([L])=>L)}).then(()=>{const Z={};
for(const r of Object.keys(n)){const L=n[r].v;Z[r]=n[r].a&&L?1:2}const C=OG2(Z);return g.IrN(U.objectStore("media"),{},r=>{const L=r.cursor.key.match(g.r3J);L&&Z[L[1]]||U.objectStore("media").delete(r.cursor.key);return g.QOn(r)}).then(()=>C)})})},gTV=async function(k,U){var n=await g.uh();
if(!n)throw g.oU("wct");n=await g.Zy(n);await g.y6(n,["captions"],{mode:"readwrite",TQ:!0},Z=>{const C=[];Z=Z.objectStore("captions");for(let r=0;r<U.length;r++){const L=Z.put(U[r],k+"|"+U[r].metadata.vss_id);C.push(L)}return g.Wi.all(C)})},XI7=async function(k){k=IDBKeyRange.bound(k+"|",k+"~");
const U=await g.uh();if(!U)throw g.oU("gactfv");return(await g.Zy(U)).getAll("captions",k)},ET_=async function(k){g.n7(k,0);
return wIY(k)},A2b=function(k){return{context:g.zg(),
videoIds:k}},ddi=function(k){return{context:g.zg(),
playlistIds:k}},Vtx=function(k){return{context:g.zg(),
offlinePlaylistSyncChecks:k}},RD_=function(){j1||(j1=new HG8);
return j1},hDY=function(k,U){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:k},metadata:U,statusCode:void 0,csn:void 0,can:void 0}},bGV=function(k,U,n){n||(n=k.S.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),n||(n=g.VP(16),k.S.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",n)));
k={flowNonce:n,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:U.eventType};U.metadata&&(k.flowMetadata=U.metadata);U.statusCode!==void 0&&(k.flowEventStatus=U.statusCode);U.csn&&(k.csn=U.csn);U.can&&(k.can=U.can);g.Rt("flowEvent",k,void 0)},zD7=async function(k){var U=await g.ar(k,{mode:"readonly",
TQ:!0},E=>qm(E,"playbackData").then(V=>{var Q=V.map(J=>J.transfer).filter(J=>!!J),p=V.map(J=>J.offlineVideoPolicy).filter(J=>!!J),I=V.filter(J=>!!J.key).map(J=>g.Cd(g.Zd(J.key).entityId,"downloadStatusEntity"));
Q=qm(E,"transfer",Q);p=qm(E,"offlineVideoPolicy",p);I=qm(E,"downloadStatusEntity",I);const t=Q.then(J=>{J=J.reduce((P,ra)=>{ra?.offlineVideoStreams&&P.push(...ra.offlineVideoStreams);return P},[]).filter(P=>!!P);
return qm(E,"offlineVideoStreams",J)});
return g.Wi.all([Q,p,t,I]).then(([J,P,ra,Lz])=>[V,J,P,ra,Lz])}));
k=await g.ar(k,{mode:"readonly",TQ:!0},E=>qm(E,"mainDownloadsListEntity").then(V=>V[0]?.downloads??[]));
const [n,Z,C,r,L]=U,F={},v={},O={},w={},u={};U=[];for(var X of Z)X&&(F[X.key]=X);for(const E of C)E&&(v[E.key]=E);for(const E of L)E&&(O[E.key]=E);for(const E of r)E&&(w[E.key]=E);for(const E of k)u[E.videoItem??""]=!0,E.videoItem&&(X=g.Zd(E.videoItem)?.entityId??"",U.push({externalVideoId:X}));return{offlineVideos:n.filter(E=>{if(!E||!E.key||!E.offlineVideoPolicy)return!1;E=g.Zd(E.key).entityId;E=g.Cd(E,"downloadStatusEntity");return!(E&&O[E]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(E=>
{var V=F[E.transfer];
const Q=[];if(V?.offlineVideoStreams)for(var p of V.offlineVideoStreams){var I=w[p];I&&Q.push(I)}p=v[E.offlineVideoPolicy];I=E?.playerResponseTimestamp;var t=g.Zd(p.key).entityId;E=g.Cd(t,"mainVideoEntity");if(p.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var J="OFFLINE_VIDEO_STATE_DISABLED";p.expirationTimestamp&&Number(p.expirationTimestamp)<Date.now()/1E3&&(J="OFFLINE_VIDEO_STATE_EXPIRED")}else if(p.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")J="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(V?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":J="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":J="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":J="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":J="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":J="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":J="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:J="OFFLINE_VIDEO_STATE_UNKNOWN"}if(J==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(V?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":J="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":J="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":J="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}t={id:t,videoState:J};
V?.cotn&&(t.cotn=V.cotn);V?.maximumDownloadQuality&&(t.selectedVideoQuality=V?.maximumDownloadQuality);V?.lastProgressTimeMs&&(t.lastProgressTimeMs=V.lastProgressTimeMs);I&&(t.playerResponseSavedTimeMs=String(Number(I)*1E3));V=String;I=0;for(const P of Q)if(P.streamsProgress)for(const ra of P.streamsProgress)I+=Number(ra.numBytesDownloaded??0);t.downloadedBytes=V(I);t.selectedOfflineMode=u[E]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";p.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(t.offlinePlaybackDisabledReason=
p.offlinePlaybackDisabledReason);return t}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:U}}}},Krp=function(){try{let n=g.RP("ytglobal.locks_");
if(n)return n;var k;if(k=navigator){var U=navigator;k="locks"in U&&!!U.locks}if(k)return g.Vs.localStorage&&g.Vs.localStorage.getItem("noop"),n=new QJE,g.HJ("ytglobal.locks_",n),n}catch{}},S1=function(k){if(k.includes(":"))throw Error(`Invalid user cache name: ${k}`);
return`${k}:${g.Hi("CacheStorage get")}`},TMV=async function(){return Gh!==void 0?Gh:Gh=new Promise(async k=>{try{await fx.open("test-only"),await fx.delete("test-only")}catch(U){if(U instanceof Error&&U.name==="SecurityError"){k(!1);
return}}k("caches"in window)})},yr=async function(){if(await TMV())return Mm||(Mm=new awi),Mm},cD=function(k,U,n){g.ed(new g.h_(`Woffle: ${k}`,n?{cotn:n}:""));
U instanceof Error&&g.ed(U)},$dB=async function(k){k=await zD7(k);
g.Rt("offlineStateSnapshot",k)},lx=function(k,U){g.LB(k.api,"onOfflineOperationFailure",U);
k.S?.postMessage(U)},pIB=function(k){if(!k.j&&!k.S){var U=Krp();
if(U){k.j=!0;var n=g.Hi("OfflineLockManager");U.request(`${"woffle_orchestration_leader"}:${n}`,{},async()=>{try{k.B=new g.A6,k.S=!0,k.j=!1,await k.X(),await k.B.promise}catch(Z){k.GW(),Z instanceof Error&&(Z.args=[{name:"WoLockManagerError",rp:Z.name}],g.S(Z))}})}}},me=function(k){k.L&&k.V&&k.W&&k.visibility.isBackground()?k.J.HV(6E4):k.J.stop()},NMV=function(k){k.S&&(k.W=!0,me(k))},ttE=function(k,U){k.S&&(k.V=U,me(k))},Iw2=function(k,U){k.S&&(k.L=U,me(k))},x7=function(k){k.offlineDeleteReason=k.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
k.offlineModeType=k.offlineModeType??"OFFLINE_NOW";g.Rt("offlineDeleteEvent",k)},ki=function(k,{videoId:U,
y6:n,offlineModeType:Z}){k.encryptedVideoId=U;k.cotn=n?.cotn;k.offlineabilityFormatType=n?.maximumDownloadQuality;k.isRefresh=n?.isRefresh??!1;k.softErrorCount=n?.transferRetryCount??0;k.offlineModeType=Z??"OFFLINE_NOW";(k.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&k.statusType==="UNKNOWN_STATUS_TYPE"||!k.transferStatusType&&!k.statusType)&&g.ed(Error("Woffle unknown transfer status"));g.Rt("offlineTransferStatusChanged",k)},qrE=function(k,U,n,Z){Z={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!Z};U&&n&&(U=Math.floor(U/1024).toFixed(),n=Math.floor(n/1024).toFixed(),Z.alreadyDownloadedKbytes=U,Z.totalFetchedKbytes=U,Z.totalContentKbytes=n);ki(Z,k)},J2E=function(k){ki({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},k)},eDp=function(k){switch(k){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
i0=function(k){return(k.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},Up=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!k.entityKey},n3=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!k.entityKey},Zl=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!k.entityKey},BM7=function(k){return k.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!k.entityKey},C3=async function(k,U,n,Z,C=!1){const r=
g.Cd(k,U),L=g.Cd(k,"downloadStatusEntity");
k=await g.ar(n,{mode:"readonly",TQ:!0},v=>g.Wi.all([I_(v,r,U),I_(v,L,"downloadStatusEntity")]));
const F=k.length?k[0]:void 0;if(F){let v=k.length>1?k[1]:void 0;if(v){if(v.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!C)return;v.downloadState=Z}else v={key:L,downloadState:Z};g.jd(F,PKB,v);await g.ar(n,{mode:"readwrite",TQ:!0},O=>g.Wi.all([g.TT(O,F,U),g.TT(O,v,"downloadStatusEntity")]))}},rW=function(k,U){return k.actionType===U.actionType&&k.entityKey===U.entityKey},L3=function(k,U){if(k&&k.transferState!=="TRANSFER_STATE_COMPLETE"&&k.transferState!=="TRANSFER_STATE_FAILED"){const n=g.Zd(k.key).entityId;
ki({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:n,y6:k,offlineModeType:U})}},FW=function(k){if(!k||!k.thumbnails)return[];
const U=[];for(const n of k.thumbnails)n.url&&U.push(n.url);return U},vt=async function(k,U,n=[]){if(!n.length)return[];
U=await D6(k,U);k=new Set;for(var Z of U)if(U=Z.id||Z.key)U=g.Zd(U).entityId,k.add(U);Z=[];for(const C of n)n=C.offlineVideoData,n?.videoId&&!k.has(n.videoId)&&Z.push(C);return Z},Op=function(k,U,n){return new g.NK(k,{cotn:U,
raw_player_response:n,download_media:!0,start:Infinity,disable_watch_next:!0})},wW=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},gW=function(k){if(!k.key)throw Error("Entity key is required.");
if(!k.actionProto)throw Error("OfflineOrchestrationAction is required.");const U=g.Zd(k.key),n=g.Zd(k.actionProto.entityKey);return new u0(n.entityType,U.entityId,k.actionProto,k.parentActionId,k.rootActionId,k.childActionIds,k.prereqActionId,k.postreqActionIds,k.retryScheduleIndex,k.hasChildActionFailed,Number(k.enqueueTimeSec)*1E3)},XW=function(k){return{key:g.Cd(k.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:k.action,parentActionId:k.parentActionId,rootActionId:k.rootActionId,childActionIds:k.childActionIds,prereqActionId:k.prereqActionId,postreqActionIds:k.postreqActionIds,retryScheduleIndex:k.retryScheduleIndex,hasChildActionFailed:k.hasChildActionFailed,enqueueTimeSec:(k.S/1E3).toFixed()}},sJO=async function(){const k=await yr();
return k?k.delete("yt-player-local-img"):!0},Ep=async function(k){const U=await yr();
if(!U)throw Error("Cache API not supported");if(k.length){var n=await U.open("yt-player-local-img");await Promise.all(k.map(Z=>n.delete(Z)))}},AH=async function(k){const U=await yr();
if(!U)throw Error("Cache API not supported");k.length&&await (await U.open("yt-player-local-img")).addAll(k)},dW=async function(k,U,n,Z,C){const r=g.Cd(k,"mainVideoEntity"),L=g.Cd(k,"ytMainChannelEntity"),F=g.Cd(k,"transfer"),v=g.Cd(k,"videoDownloadContextEntity");
var O=await g.ar(U,{mode:"readonly",TQ:!0},J=>g.Wi.all([I_(J,r,"mainVideoEntity"),I_(J,L,"ytMainChannelEntity"),I_(J,F,"transfer"),I_(J,v,"videoDownloadContextEntity"),qm(J,"ytMainChannelEntity"),qm(J,"offlineOrchestrationActionWrapperEntity")]));
const [w,u,X,E,V,Q]=O;if(w||u){O=w?FW(w.thumbnail):[];var p=u?await Yrb(u,V):[];await Ep(O.concat(p))}const I=[],t=g.Cd(k,"downloadStatusEntity");for(const J of Q)O=g.Zd(J.key).entityId,p=gW(J),p=g.Zd(p.action.entityKey).entityId,O!==k&&p!==k||rW(n,J.actionProto)||I.push(J.key);await g.ar(U,{mode:"readwrite",TQ:!0},J=>{const P=I.map(ra=>e1(J,ra));
P.push(e1(J,r,{qg:!0}));P.push(e1(J,t,{qg:!0}));return g.Wi.all(P)});
k=E?.offlineModeType;C&&(x7(C),C.offlineModeType&&(k=C.offlineModeType));L3(X,k);lx(Z,{entityKey:r,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},V4=async function(k,U,n,Z){const C=g.Cd(k,"mainPlaylistEntity"),r=g.Cd(k,"ytMainChannelEntity");
var L=await g.ar(U,{mode:"readonly",TQ:!0},J=>g.Wi.all([I_(J,C,"mainPlaylistEntity"),I_(J,r,"ytMainChannelEntity"),qm(J,"mainPlaylistEntity"),qm(J,"mainDownloadsListEntity"),qm(J,"ytMainChannelEntity"),qm(J,"offlineOrchestrationActionWrapperEntity")]));
const [F,v,O,w,u,X]=L;if(F||v){L=F?Ddi(F):[];var E=v?await Yrb(v,u):[];await Ep(L.concat(E))}L=[];E=new Map;if(F){L=await oT_(F,O,w);for(var V of L)E.set(V,{videoId:V,playlistId:k,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});V=await g.ar(U,{mode:"readonly",TQ:!0},ra=>g.Wi.all([qm(ra,"transfer"),qm(ra,"videoDownloadContextEntity")]));
const [J,P]=V;for(var Q of J)V=g.Zd(Q.key).entityId,(V=E.get(V))&&Q&&(V.cotn=Q.cotn);for(var p of P)Q=g.Zd(p.key).entityId,(Q=E.get(Q))&&p&&(Q.offlineModeType=p.offlineModeType)}const I=[];for(const J of X)p=g.Zd(J.key).entityId,Q=gW(J),p!==k&&Q.rootActionId!==k||rW(n,J.actionProto)||I.push(J.key);const t=g.Cd(k,"mainPlaylistEntity");await g.ar(U,{mode:"readwrite",TQ:!0},J=>{const P=I.map(ra=>e1(J,ra));
P.push(e1(J,t,{qg:!0}));return g.Wi.all(P)});
if(F&&(L.reverse(),L))for(const J of L)await dW(J,U,n,Z,E.get(J))},Ht=async function(k,U,n,Z){const C=g.Cd("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),r=new Map;
k=await g.ar(k,{mode:"readwrite",TQ:!0},L=>{const F=qm(L,"transfer"),v=qm(L,"offlineOrchestrationActionWrapperEntity"),O=qm(L,"videoDownloadContextEntity"),w=I_(L,C,"mainDownloadsListEntity");return g.Wi.all([F,v,O,w]).then(([u,X,E,V])=>{const Q=WrO.map(p=>BD(L,p));
for(const p of X)rW(U,p.actionProto)||Q.push(e1(L,p.key,{qg:!0}));V&&(V.downloads=[],Q.push(g.TT(L,V,"mainDownloadsListEntity")));if(E)for(const p of E)X=g.Zd(p.key).entityId,X=g.Cd(X,"transfer"),r.set(X,p.offlineModeType);return g.Wi.all(Q).then(()=>u)})});
for(const L of k){L3(L,r.get(L.key));k=g.Zd(L.key).entityId;const F={videoId:k,offlineDeleteReason:Z,cotn:L.cotn,offlineModeType:r.get(L.key)};x7(F);k=g.Cd(k,"mainVideoEntity");lx(n,{entityKey:k,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await sJO()},Ddi=function(k,U){let n=[];
if(k.thumbnailStyleData)for(const Z of k.thumbnailStyleData)n=n.concat(FW(Z?.value?.collageThumbnail?.coverThumbnail));k=FW(U);return n.concat(k)},oT_=async function(k,U,n){const Z=[],C=new Set;
if(n.length)for(var r of n)if(r.downloads?.length)for(const L of r.downloads)L.videoItem&&(n=g.Zd(L.videoItem).entityId,C.add(n));if(k.videos){for(const L of k.videos)r=JSON.parse(g.Zd(L).entityId),r.videoId&&!C.has(r.videoId)&&Z.push(r.videoId);for(const L of U)if(L.key!==k.key&&(U=L.videos))for(const F of U)U=JSON.parse(g.Zd(F).entityId),U.videoId&&(U=Z.indexOf(U.videoId),U!==-1&&Z.splice(U,1))}return Z},Yrb=async function(k,U){const n=FW(k.avatar);
for(const Z of U)if(Z.id!==k.id)for(const C of FW(Z.avatar))U=n.indexOf(C),U!==-1&&n.splice(U,1);return n},jJ7=async function(k){const U=g.e(k.frameworkUpdates,RR);
k.frameworkUpdates&&U&&await WD(U)},fw_=function(k){if(k.onResponseReceivedActions?.length&&(k=g.e(g.e(k.onResponseReceivedActions[0],Sri),G6B)?.actions,k?.length))return k},MtY=async function(k){if(!k)return[];
k=await Y7(k,g.CO,"mainDownloadsListEntity");return k?.downloads?.length?k.downloads.map(U=>U.videoItem??""):[]},hH=async function(k,U){const n=await y2p(k,U);
n&&await g.ar(k,{mode:"readwrite",TQ:!0},Z=>{const C=[g.TT(Z,n.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];n.mainDownloadsListEntity&&C.push(g.TT(Z,n.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.Wi.all(C)})},y2p=async function(k,U){const n=g.Cd("main_downloads_library_id","mainDownloadsLibraryEntity"),Z=g.Cd("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
k=await g.ar(k,{mode:"readonly",TQ:!0},v=>g.Wi.all([I_(v,n,"mainDownloadsLibraryEntity"),I_(v,Z,"mainDownloadsListEntity")]));
let [C,r]=k;k=C;let L=r;k||(k={id:n});for(const v of U)if(v===g.CO){if(k.smartDownloadsList)return;k.smartDownloadsList=v}else{var F=g.Zd(v).entityType;U={};F==="mainPlaylistEntity"?U.playlistItem=v:F==="mainVideoEntity"&&(U.videoItem=v);if(!g.Gp(U)){if(L?.downloads){F=!1;for(const O of L.downloads)if(O.playlistItem===v||O.videoItem===v){F=!0;break}F||L.downloads.push(U)}else L={id:Z,downloads:[U]};k.downloadsList=Z}}return{mainDownloadsLibraryEntity:k,mainDownloadsListEntity:L}},b0=async function(k,
U){const n=g.Cd("main_downloads_library_id","mainDownloadsLibraryEntity"),Z=g.Cd("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var C=await g.ar(k,{mode:"readonly",TQ:!0},v=>g.Wi.all([I_(v,n,"mainDownloadsLibraryEntity"),I_(v,Z,"mainDownloadsListEntity"),I_(v,g.CO,"mainDownloadsListEntity")]));
const [r,L,F]=C;if(r){if(U===g.CO&&F?.downloads)F.downloads=[];else if(L?.downloads){C=g.Zd(U).entityType;for(let v=0;v<L.downloads.length;v++){const O=L.downloads[v];if(C==="mainVideoEntity"&&O.videoItem===U){L.downloads.splice(v,1);break}else if(C==="mainPlaylistEntity"&&O.playlistItem===U){L.downloads.splice(v,1);break}}}await g.ar(k,{mode:"readwrite",TQ:!0},v=>{const O=[g.TT(v,r,"mainDownloadsLibraryEntity")];L&&O.push(g.TT(v,L,"mainDownloadsListEntity"));F&&O.push(g.TT(v,F,"mainDownloadsListEntity"));
return g.Wi.all(O)})}},zR=async function(k,U){const n=g.Cd(U,"transfer"),Z=g.Cd(U,"videoDownloadContextEntity");
k=await g.ar(k,{mode:"readonly",TQ:!0},L=>g.Wi.all([I_(L,n,"transfer"),I_(L,Z,"videoDownloadContextEntity")]));
const [C,r]=k;return{videoId:U,cotn:C?.cotn,offlineModeType:r?.offlineModeType}},Q4=async function(k,U,n,Z,C){const r=g.Cd(k,"musicTrack"),L=g.Cd(k,"transfer");
var F=await g.ar(U,{mode:"readonly",TQ:!0},V=>g.Wi.all([I_(V,r,"musicTrack"),I_(V,L,"transfer"),qm(V,"musicTrack"),qm(V,"offlineOrchestrationActionWrapperEntity")]));
const [v,O,w,u]=F;v&&(F=await c2V(v,w),await Ep(F));const X=[];for(const V of u){F=g.Zd(V.key).entityId;var E=gW(V);E=g.Zd(E.action.entityKey).entityId;F!==k&&E!==k||rW(n,V.actionProto)||X.push(V.key)}await g.ar(U,{mode:"readwrite",TQ:!0},V=>{const Q=X.map(p=>e1(V,p));
Q.push(e1(V,r,{qg:!0}));return g.Wi.all(Q)});
L3(O);C&&x7(C);lx(Z,{entityKey:r,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},K3=async function(k,U,n,Z,C){const r=g.Cd(k,U),L=g.Cd("music_downloads_library_id","musicDownloadsLibraryEntity");
var F=await g.ar(n,{mode:"readonly",TQ:!0},I=>g.Wi.all([I_(I,r,U),I_(I,L,"musicDownloadsLibraryEntity"),qm(I,U),qm(I,"offlineOrchestrationActionWrapperEntity")]));
const [v,O,w,u]=F;v&&(F=await c2V(v,w),await Ep(F));let X=[];F=new Map;if(v){X=await lw7(v,w,O);for(var E of X){const I=g.Zd(E).entityId;F.set(I,{videoId:I,playlistId:k,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}E=await D6(n,"transfer");for(var V of E)E=g.Zd(V.key).entityId,(E=F.get(E))&&V&&(E.cotn=V.cotn)}const Q=[];for(const I of u)V=g.Zd(I.key).entityId,E=gW(I),V!==k&&E.rootActionId!==k||rW(Z,I.actionProto)||Q.push(I.key);const p=g.Cd(k,U);await g.ar(n,{mode:"readwrite",TQ:!0},
I=>{const t=Q.map(J=>e1(I,J));
t.push(e1(I,p,{qg:!0}));return g.Wi.all(t)});
if(v&&(X.reverse(),X.length))for(const I of X)(k=g.Zd(I).entityId)&&await Q4(k,n,Z,C,F.get(k))},TR=async function(k,U,n){k=await g.ar(k,{mode:"readwrite",
TQ:!0},Z=>{const C=qm(Z,"transfer"),r=qm(Z,"offlineOrchestrationActionWrapperEntity");return g.Wi.all([C,r]).then(([L,F])=>{const v=mdE.map(O=>BD(Z,O));
for(const O of F){F=g.Zd(O.actionProto.entityKey).entityType==="musicTrack";const w=O.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";rW(U,O.actionProto)||F&&(!F||w)||v.push(e1(Z,O.key,{qg:!0}))}return g.Wi.all(v).then(()=>L)})});
for(const Z of k)L3(Z),k=g.Zd(Z.key).entityId,x7({videoId:k,offlineDeleteReason:void 0,cotn:Z.cotn}),k=g.Cd(k,"musicTrack"),lx(n,{entityKey:k,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await sJO()},xdO=function(k){let U;
for(const n of k.additionalMetadatas)n.offlineMusicVideoData&&(U=n.offlineMusicVideoData);return{id:g.Cd(k.videoId,"musicTrack"),videoId:k.videoId,title:k.title,thumbnailDetails:k.thumbnail,lengthMs:String(Number(k.lengthSeconds)*1E3),albumTitle:U?.releaseTitle,musicVideoType:U?.musicVideoType,contentRating:{explicitType:U?.explicitType},artistNames:U?.byline||U?.channelName,downloadMetadata:g.Cd(k.videoId,"musicTrackDownloadMetadataEntity")}},lw7=async function(k,U,n){const Z=[],C=new Set;
if(n?.downloadedTracks?.length)for(const r of n.downloadedTracks)C.add(r);if(k.tracks){for(const r of k.tracks)C.has(r)||Z.push(r);for(const r of U)if(r.id!==k.id&&(U=r.tracks))for(const L of U)U=Z.indexOf(L),U!==-1&&Z.splice(U,1)}return Z},c2V=async function(k,U){const n=FW(k.thumbnailDetails);
for(const Z of U)if(Z.id!==k.id)for(const C of FW(Z.thumbnailDetails))U=n.indexOf(C),U!==-1&&n.splice(U,1);return n},aR=async function(k,U){var n=g.Cd("music_downloads_library_id","musicDownloadsLibraryEntity");
let Z=await Y7(k,n,"musicDownloadsLibraryEntity");Z||(Z={id:n});n=g.Zd(U).entityType;n==="musicTrack"?Z.downloadedTracks?.includes(U)||(Z.downloadedTracks=(Z.downloadedTracks??[]).concat(U)):n==="musicPlaylist"?Z.downloadedPlaylists?.includes(U)||(Z.downloadedPlaylists=(Z.downloadedPlaylists??[]).concat(U)):n!=="musicAlbumRelease"||Z.downloadedAlbumReleases?.includes(U)||(Z.downloadedAlbumReleases=(Z.downloadedAlbumReleases??[]).concat(U));await g.$J(k,Z,"musicDownloadsLibraryEntity")},$i=async function(k,
U){var n=g.Cd("music_downloads_library_id","musicDownloadsLibraryEntity");
if(n=await Y7(k,n,"musicDownloadsLibraryEntity")){var Z=g.Zd(U).entityType;let C;Z==="musicTrack"?C=n.downloadedTracks:Z==="musicPlaylist"&&(C=n.downloadedPlaylists);if(C?.length)for(Z=0;Z<C.length;Z++)if(C[Z]===U){C.splice(Z,1);break}await g.$J(k,n,"musicDownloadsLibraryEntity")}},klp=function(k){var U=k.videos;
k=[];const n=[];if(U)for(const C of U){var Z=C.offlineVideoData.videoId;U=g.Cd(Z,"musicTrack");Z=g.Cd(Z,"musicTrackDownloadMetadataEntity");k.push(U);n.push(Z)}return{rK:k,SQ:n}},p3=function(k,U,n){U={track:xdO(U)};
n&&(U.playlistId=n);if(k=g.e(k.actionMetadata,ilm))U.maximumDownloadQuality=k.maximumDownloadQuality;return{musicTrackEntityActionMetadata:U}},n2E=async function(k){var U=g.Ob();
k=A2b(k);const n=g.g2(UDB);try{var Z=await g.ch(U,k,n,void 0,{e7:!0})}catch(C){if(C instanceof g.ZK)throw Z=`GetOffline network manager error: ${C.message}`,cD(Z,C),Error(Z);cD("GetOffline fetch request error",C);throw Error("GetOffline fetch request error");}U=Z.errorMetadata?.status;if(!Z)throw cD("Network request failed"),Error("Network request failed");if(U!==void 0)Nu(U);else if(!Z.videos||!Z.videos.length)throw cD("No data"),Error("No data");return Z.videos.map(C=>C.offlineVideoData)},tH=async function(k){var U=
g.Ob();
k=ddi(k);const n=g.g2(UDB);try{var Z=await g.ch(U,k,n,void 0,{e7:!0})}catch(C){if(C instanceof g.ZK)throw Z=`GetOffline network manager error for playlist: ${C.message}`,cD(Z,C),Error(Z);cD("GetOffline fetch request error for playlist",C);throw Error("GetOffline fetch request error for playlist");}U=Z.errorMetadata?.status;if(!Z)throw cD("Network request failed for playlist"),Error("Network request failed for playlist");if(U!==void 0)Nu(U,"playlist");else if(!Z.playlists||!Z.playlists.length)throw cD("No data for playlist"),
Error("No data for playlist");return Z.playlists.map(C=>C.offlinePlaylistData)},CwV=async function(k,U,n,Z){const C=await g.Nj();
if(!C)return[];var r=[];Z?.length?r=Z:r=await D6(C,"mainPlaylistEntity");if(!r.length)return[];Z=[];const L=Date.now()/1E3;for(const w of r){var F=w.downloadState?await Y7(C,w.downloadState,"mainPlaylistDownloadStateEntity"):void 0,v=(r=w?.entityMetadata)&&r.nextAutoRefreshIntervalSeconds?Number(r.nextAutoRefreshIntervalSeconds):NaN;v=Number.isNaN(v)?k:v;var O=F?.lastSyncedTimestampMillis?Number(F?.lastSyncedTimestampMillis)/1E3:0;F=F?.addedTimestampMillis?Number(F?.addedTimestampMillis)/1E3:0;if(n||
!r||O+v<=L){v=[];if(w.videos?.length)for(const u of w.videos)O=JSON.parse(g.Zd(u).entityId),O.videoId&&v.push(O.videoId);O="0";r&&(O=String(Number(r.offlineLastModifiedTimestampSeconds??0).toFixed()));Z.push({playlistId:w.playlistId,videoIds:v,offlineLastModifiedTimestamp:O,autoSync:U,offlineDateAddedTimestamp:String(F.toFixed())})}}return Z.length?await Zlm(Z):[]},rMY=async function(){var k=await g.Nj();
if(!k)return!1;k=await D6(k,"refresh");if(!k[0]?.refreshTime)return!1;k=Number(k[0].refreshTime);const U=Date.now()/1E3;return isFinite(k)&&U>=k},FIY=async function(k,U){let n;
try{const Z=await LIV(k,U);await jJ7(Z);n=fw_(Z)}catch(Z){cD("getAndProcessSmartDownloadsResponse request or processing error",Z)}return n},v2V=async function(k,U,n,Z){const C=await g.Nj();
if(!C)return[];var r=[];Z?.length?r=Z:r=await D6(C,"musicPlaylist");if(!r.length)return[];Z=[];const L=Date.now()/1E3;for(const O of r){var F=(r=O?.entityMetadata)&&r.nextAutoRefreshIntervalSeconds?Number(r.nextAutoRefreshIntervalSeconds):NaN;const w=Number.isNaN(F)?k:F;let u=F=0;var v="DOWNLOAD_SYNC_STATE_UNKNOWN";O.downloadMetadata&&(v=await Y7(C,O.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),F=Number(v?.addedTimestampMillis??"0")/1E3,u=Number(v?.lastModifiedTimestampMillis??"0")/1E3,
v=v?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(n||v!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!r||Number(r.lastSyncedTimestampSeconds??0)+w<=L){r=[];if(O.tracks?.length)for(const X of O.tracks)r.push(g.Zd(X).entityId);Z.push({playlistId:O.playlistId,videoIds:r,offlineLastModifiedTimestamp:String(u.toFixed()),autoSync:U,offlineDateAddedTimestamp:String(F.toFixed())})}}return Z.length?await Zlm(Z):[]},LIV=async function(k,U){var n=g.Ob(),Z=await g.Nj();
let C;Z&&(C=await zD7(Z));Z=C;k={context:g.zg(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:k},offlineClientState:Z,clientStateRequestData:{preferredFormatType:U}}}};U=g.g2(Ols);try{var r=await g.ch(n,k,U,void 0,{e7:!0})}catch(L){if(L instanceof g.ZK)throw r=`DPS network manager error for smart downloads: ${L.message}`,cD(r,L),Error(r);cD("DPS fetch request error for smart downloads",L);throw Error("DPS fetch request error for smart downloads");
}n=r.errorMetadata?.status;if(r)n!==void 0&&Nu(n,"smart downloads");else throw cD("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return r},uZp=async function(k,U){var n=g.Ob();
k={context:g.zg(),videoPlaybackPositionEntities:k,lastSyncTimestampUsec:U};U=g.g2(wai);try{var Z=await g.ch(n,k,U,void 0,{e7:!0})}catch(C){if(C instanceof g.ZK)throw Z=`VPPS network manager error: ${C.message}`,cD(Z,C),Error(Z);cD("VPPS fetch request error",C);throw Error("VPPS fetch request error");}n=Z.errorMetadata?.status;if(Z)n!==void 0&&Nu(n,"position sync");else throw cD("Network request failed for position sync"),Error("Network request failed for position sync");return Z},Xai=async function(k,
U,n){var Z=g.Ob(),C=n.refreshData,r=n.isEnqueuedForExpiredStreamUrlRefetch,L=n.tb,F=n.offlineSourceData;
n=n.mediaCapabilities;k={entityKey:k};C&&(k.refreshData=C);r&&(k.isExpiredStreamUrlRefetch=r);L&&(k.downloadParameters=L);F&&(k.offlineSourceData=F);U={context:g.rh(U),signatureTimestamp:20501,videos:[k]};n&&(U.mediaCapabilities=n);C=g.g2(g2_);try{var v=await g.ch(Z,U,C,void 0,{e7:!0})}catch(O){if(O instanceof g.ZK)throw v=`GetPDE network manager error: ${O.message}`,cD(v,O),Error(v);cD("GetPDE fetch request error",O);throw Error("GetPDE fetch request error");}Z=v.errorMetadata?.status;if(v)Z!==void 0&&
Nu(Z,"PDE");else throw cD("Network request failed for PDE"),Error("Network request failed for PDE");return v},Nu=function(k,U){U=U?` for ${U}`:"";
if(k===0)throw k=`Empty response body${U}`,cD(k),Error(k);k=`Response with error${U}`;cD(k);throw Error(k);},Zlm=async function(k){var U=g.Ob();
k=Vtx(k);const n=g.g2(E2V);try{var Z=await g.ch(U,k,n,void 0,{e7:!0})}catch(C){if(C instanceof g.ZK)throw Z=`offlinePlaylistSyncCheck network manager error: ${C.message}`,cD(Z,C),Error(Z);cD("offlinePlaylistSyncCheck fetch request error",C);throw Error("offlinePlaylistSyncCheck fetch request error");}U=Z.errorMetadata?.status;if(!Z)throw cD("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(U!==void 0)Nu(U,"playlist sync");else if(!Z.offlinePlaylistSyncCheckDatas||
!Z.offlinePlaylistSyncCheckDatas.length)throw cD("No data for playlist sync"),Error("No data for playlist sync");return Z.offlinePlaylistSyncCheckDatas.map(C=>C.offlinePlaylistSyncCheckData)},AM2=async function(k,U){const n=new Map;
for(const Z of U)n.set(Z,await k.B(Z));return n},IR=function(k,U,n,Z,C,r){U=g.Cd(U,n);
return{actionType:k,entityKey:U,actionMetadata:{...r,priority:Z,retryScheduleIntervalsInSeconds:C}}},HlV=async function(k,U){var n=U.entityKey;
const Z=g.e(U.actionMetadata,qu)?.isEnqueuedForExpiredStreamUrlRefetch;try{let r=void 0;r=await dDp(k,U);let L;try{{const F=g.e(U.actionMetadata,qu);var C=F?{maximumDownloadQuality:F.maximumDownloadQuality}:void 0}L=await Xai(n,k.k$,{isEnqueuedForExpiredStreamUrlRefetch:Z,tb:C,offlineSourceData:r})}catch(F){const v=i0(U)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";cD("PDE handleAdd error");return JH(U,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",v,"DOWNLOAD_STATE_FAILED")}await Voi(k,L,U);return JH(U,!0,L.orchestrationActions)}catch(r){return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",r instanceof g.Pi&&r.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",n="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),cD("PDE handleAdd error"),JH(U,!1,void 0,k,n,"DOWNLOAD_STATE_FAILED")}},
bl7=async function(k,U){const n=U.entityKey,Z=g.Zd(n).entityId;
var C=await g.ar(k.S,{mode:"readonly",TQ:!0},u=>{const X=I_(u,n,"playbackData"),E=I_(u,g.Cd(Z,"offlineVideoPolicy"),"offlineVideoPolicy");u=I_(u,g.Cd(Z,"transfer"),"transfer");return g.Wi.all([X,E,u])});
const [r,L,F]=C;if(!r||!L)return JH(U,!0);C=[];var v=r?.playerResponseJson?JSON.parse(r.playerResponseJson):null;if(F&&v){var O=R62(k,v,F);C=await h62(k,F)}C={lastPlayerResponseTimestampSeconds:r.playerResponseTimestamp,offlineToken:L.offlineToken,formatIds:C};v={};F?.maximumDownloadQuality&&(v.maximumDownloadQuality=F.maximumDownloadQuality);try{let u=void 0;u=await dDp(k,U);try{var w=await Xai(n,k.k$,{refreshData:C,tb:v,offlineSourceData:u,mediaCapabilities:O})}catch(X){const E=i0(U)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";cD("PDE handleRefresh error");return JH(U,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",E,"DOWNLOAD_STATE_FAILED")}await Voi(k,w,U);return JH(U,!0,w.orchestrationActions)}catch(u){return k="PDE handleRefresh error",u instanceof Error&&(k=`PDE handleRefresh error: ${u.message}`),O="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",w="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",u instanceof g.Pi&&u.type===
"QUOTA_EXCEEDED"&&(O="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",w="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),cD(k),JH(U,!1,void 0,O,w,"DOWNLOAD_STATE_FAILED")}},dDp=async function(k,U){U=g.Zd(U.entityKey).entityId;
U=g.Cd(U,"videoDownloadContextEntity");k=await Y7(k.S,U,"videoDownloadContextEntity");return k?.offlineModeType?{offlineModeType:k.offlineModeType}:void 0},JH=function(k,U,n,Z,C,r){return new eT(U?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",i0(k),n,Z,C,r)},Voi=async function(k,U,n){if(U.frameworkUpdates&&g.e(U.frameworkUpdates,RR)){if(g.e(U.frameworkUpdates,RR).mutations&&g.e(U.frameworkUpdates,RR).mutations.length>0&&g.e(U.frameworkUpdates,RR).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const Z=g.Zd(g.e(U.frameworkUpdates,RR).mutations[0].entityKey).entityId,C=await zR(k.S,Z),r=g.e(n.actionMetadata,qu)?.playlistId;
r&&(C.playlistId=r);C.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.kD(k.k$)?await dW(Z,k.S,n,k.j,C):g.mN(k.k$)&&await Q4(Z,k.S,n,k.j)}await WD(g.e(U.frameworkUpdates,RR))}},R62=function(k,U,n){U=Op(k.k$,n.cotn,U);
n=g.I3(U);return g.hgB(U,n,k.k$)},h62=async function(k,U){const n=[];
if(k=await g.ar(k.S,{mode:"readonly",TQ:!0},Z=>{const C=[],r=U.offlineVideoStreams;if(r)for(const L of r)C.push(I_(Z,L,"offlineVideoStreams"));return g.Wi.all(C)}))for(const Z of k)if(Z?.streamsProgress){k=Z.streamsProgress;
for(let C=0;C<k.length;C++){const r=JSON.parse(k[C].formatStreamBytes);n.push({itag:r.itag,lmt:r.lastModified,xtags:r.xtags})}}return n},z6E=async function(k,U){U=i0(U);
k=await D6(k.S,"videoPlaybackPositionEntity");if(k.length===0)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",U);try{const n=await Bt.getInstance();if(!n)throw Error("prefStorage is undefined");const Z=(await n.get("psi"))?.aX??"0",C=await uZp(k,Z),r={isPaused:C.watchHistoryPaused,aX:C.syncTimestampUsec};await n.set("psi",r);if(!r.isPaused){const L=g.e(C.frameworkUpdates,RR);C.frameworkUpdates&&L&&await WD(L)}}catch(n){return cD("PPE handleRefresh error: "+(n instanceof Error?n.message:
"unknown error")),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",U,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",U)},KIY=async function(k,U){const n=i0(U),Z=g.Zd(U.entityKey).entityId;
try{const C=await Bt.getInstance();if(!C)throw Error("prefStorage is undefined");const r=await C.get("psi"),L=g.e(U.actionMetadata,Q5b);if(r?.isPaused===!1&&L?.lastPlaybackPositionSeconds){const F={key:g.Cd(Z,"videoPlaybackPositionEntity"),videoId:Z,lastPlaybackPositionSeconds:L.lastPlaybackPositionSeconds};await g.$J(k.S,F,"videoPlaybackPositionEntity")}}catch(C){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
n)},TVO=async function(k,U){const n=i0(U);
try{const Z=g.Zd(U.entityKey).entityId;if(Z==="!*$_ALL_ENTITIES_!*$")await nTE(k.S);else{const C=g.Cd(Z,"videoPlaybackPositionEntity");await PD(k.S,C)}}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},Pt=async function(k){return ET_(k)},a__=async function(k){return(await g.ngC(k)).filter(U=>!!U.url).map(U=>
U.url)},sp=function(k,U){var n=g.Un(U);
if(n===1||n===0)return Promise.resolve();(n=k.player?.getVideoData().videoId===U?k.player:null)&&n.stopVideo();k.j=0;return Pt(U)},Yi=function(k,U,n=!1,Z=!0){U=typeof U==="string"?U:U.videoDetails.videoId;
if(g.Un(U)===2){var C=k.player?.getVideoData().videoId===U?k.player:null;C&&C.stopVideo();g.n7(U,2);k.j=2;n?$DY(k.S):Z&&pas(k.S)}},to7=async function(k,U){const n=i0(U);
if(await Y7(k.S,U.entityKey,"transfer"))return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);try{await NVY(k,U)}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},I_E=async function(k,U){const n=i0(U),Z=await Y7(k.S,U.entityKey,"transfer");
if(!Z||Z.transferState!=="TRANSFER_STATE_COMPLETE")return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);try{await NVY(k,U,!0)}catch(C){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},qFx=async function(k,U){const n=i0(U),Z=g.Zd(U.entityKey).entityId,C=await g.ar(k.S,{mode:"readonly",
TQ:!0},F=>{const v=I_(F,U.entityKey,"transfer");F=I_(F,g.Cd(Z,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.Wi.all([v,F])}),[r,
L]=C;if(!r||r.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);try{r.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await g.$J(k.S,r,"transfer");const F=g.Zd(r.key).entityId;ki({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:F,y6:r,offlineModeType:L?.offlineModeType})}catch(F){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},NVY=async function(k,U,n=!1){const Z=g.e(U.actionMetadata,JMB),C=g.Zd(U.entityKey).entityId,r=g.Cd(C,"downloadStatusEntity");
var L=await g.ar(k.S,{mode:"readonly",TQ:!0},w=>{const u=I_(w,r,"downloadStatusEntity");w=I_(w,g.Cd(C,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.Wi.all([u,w])});
const [F,v]=L;L="TRANSFER_STATE_TRANSFER_IN_QUEUE";F?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(L="TRANSFER_STATE_PAUSED_BY_USER");const O={key:U.entityKey,transferState:L,cotn:g.VP(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:Z?.maximumDownloadQuality,preferredAudioTrack:Z?.preferredAudioTrack,transferRetryCount:0,isRefresh:n,hasLoggedFirstStarted:!1};await g.ar(k.S,{mode:"readwrite",TQ:!0},w=>{const u=[];n&&u.push(e1(w,g.Cd(C,"offlineVideoStreams")));u.push(g.TT(w,
O,"transfer"));return g.Wi.all(u)});
n&&await Pt(C);ki({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:C,y6:O,offlineModeType:v?.offlineModeType})},BVV=function(k,U,n,Z){if(!k.action.entityKey)throw Error("entityKey is missing.");
const {H4:C,entityId:r}=g.Zd(k.action.entityKey),L={entityType:C,entityId:r,offlineOrchestrationActionType:k.action.actionType,orchestrationAction:{orchestrationActionId:k.actionId}};U&&(L.offlineOrchestrationActionResult=U.status,L.isRetryable=n?!1:U.S,U.j&&(L.offlineOrchestrationFailureReason=e6x(U.j,L.isRetryable)));k.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(L.offlineModeType=k.action.actionMetadata.offlineLoggingData.offlineModeType);Z&&(L.additionalOrchestrationActions=Z.map(F=>
({orchestrationActionId:F.actionId})));
return L},e6x=function(k,U){return k!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||U?k==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&U?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":k:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},Dl=function(k,U){const n={offlineOrchestrationContext:BVV(k)};
U=hDY(U,n);bGV(RD_(),U,k.rootActionId)},oR=function(k,U,n,Z=[]){U={offlineOrchestrationContext:BVV(k,U,n,Z)};
U=hDY(3,U);bGV(RD_(),U,k.rootActionId)},Pw2=function(k,U){for(const n of U)Dl(n,1),k.actions.push(n);
k.actions.sort(k.S)},s5V=function(k,U){if(U)for(let n=0;n<k.actions.length;n++)if(U==="!*$_ALL_ENTITIES_!*$"&&k.actions[n].actionId!==U||U!=="!*$_ALL_ENTITIES_!*$"&&k.actions[n].rootActionId===U&&k.actions[n].actionId!==U)k.actions.splice(n,1),n--},YFV=function(k,U){for(const n of k.actions)if(n.actionId===U)return!0;
return!1},j5x=async function(k,U,n,Z,C){k=new DD7(k,U,n,Z,C);
await o2_(k);WIs(k);return k},o2_=async function(k){const U=await D6(k.B,"offlineOrchestrationActionWrapperEntity");
await Wt(k,U)},WIs=function(k){const U=k.S.actions[0];
return k.J?(U?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&k.J[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(k.W=!0),Promise.resolve()):SFY(k)},SFY=async function(k){if(k.J)throw Error("Already processing an action");
if(!k.LN()){var U=k.S.actions.shift();ttE(k.dM,!U);if(U!==void 0){U.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&U.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&s5V(k.S,U.actionId);var n="";U.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&U.rootActionId===U.actionId&&(n=U.actionId);var Z=[U];k.J=Z;if(U=k.SE[U.entityType]){for(const C of Z)Dl(C,2);try{const C=await AM2(U,Z.map(r=>r.action));
for(const r of Z){const L=C.get(r.action);await Gl8(k,r,L)}s5V(k.S,n)}catch(C){cD("Orchestration error",C);try{await f_2(k,Z)}catch(r){cD("Orchestration retry error",r);for(const L of Z)L.retryScheduleIndex<3&&Pw2(k.S,[L])}}finally{k.J=void 0}}else k.J=void 0;await SFY(k)}}},Gl8=async function(k,U,n){var Z=U.retryScheduleIndex+2===3;
if(n.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var C=void 0;try{C=n.J?.map(r=>k.createAction(r,U))}catch(r){oR(U,n,Z);
lx(k.L,{entityKey:U.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});cD("Orchestration subactions creation error",r);return}oR(U,n,Z,C);if(C){const r=C.map(F=>XW(F));
let L=0;for(;L<C.length&&!k.W;)await g.ar(k.B,{mode:"readwrite",TQ:!0},F=>{const v=[];v.push(J4(F,r.slice(L,L+10),"offlineOrchestrationActionWrapperEntity"));return g.Wi.all(v)}),L+=10;
if(k.W){k.W=!1;return}}n=XW(U);await PD(k.B,n.key);Dl(U,4)}else if(n.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(oR(U,n,Z),n.S&&U.retryScheduleIndex+1<3)await f_2(k,[U]);else{Z={entityKey:U.action.entityKey,failureReason:n?.B?n.B:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};C=void 0;g.kD(k.k$)?C="mainVideoDownloadStateEntity":g.mN(k.k$)&&(C="musicTrackDownloadMetadataEntity");if(C&&n.downloadState){const r=g.Zd(U.action.entityKey).entityId;await C3(r,C,k.B,n.downloadState)}lx(k.L,Z);
n.downloadState==="DOWNLOAD_STATE_FAILED"&&k.k$.C("html5_auto_retry_failed_pde_actions")||(cD("Orchestration result is not retryable, deleting action"),await PD(k.B,XW(U).key))}},f_2=async function(k,U){for(const n of U){const Z=n.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let C=1;n.retryScheduleIndex<Z.length&&(C=Z[n.retryScheduleIndex]);n.S=C*1E3+Date.now();n.retryScheduleIndex++}await Mos(k,U)},yMi=async function(k,U){return(await D6(k.B,"offlineOrchestrationActionWrapperEntity",U)).filter(vT7)},Wt=async function(k,U){let n=[];
var Z=Infinity;let C=4E3;for(const L of U){U=Number(L.enqueueTimeSec);const F=cMY(U);var r=L.retryScheduleIndex;r=r!=null&&r>0;F>0&&r?(Z=Math.min(Z,U),C=Math.min(F,C)):n.push(L)}isFinite(Z)&&(!k.j.isActive()||Z<k.X)&&(k.X=Z,k.j.start(C));k.V.SB()||(Z=n.length,n=n.filter(L=>!l_7.includes(L.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),Z=n.length<Z,!k.j.isActive()&&Z&&k.j.start(1));
n.length>0&&mDO(k,n);await WIs(k)},cMY=function(k){k=k*1E3-Date.now();
return k>4E3?4E3:k},mDO=function(k,U){U.length!==0&&U.forEach(n=>{n=gW(n);
n.retryScheduleIndex<3&&Pw2(k.S,[n])})},xD7=async function(k){var U=await yMi(k);
const n=[];for(const Z of U)U=g.Zd(Z.key).entityId,YFV(k.S,U)||n.push(Z);await Wt(k,n)},Mos=function(k,U){if(U.length===0)return Promise.resolve([]);
U=U.map(n=>XW(n));
return UdV(k.B,U)},kr7=async function(k,U){const n=U.videoId;
let Z=!0;if(U.captionTracks.length){const C=ZG7(U);k.S=new g.P4(k.y$,U,C)}else if(U.tS)k.S=new g.sH(k.y$,U.tS,n,g.HmB(U),U.f1,U.eventId),Z=U.f1;else return;return new Promise(C=>{k.S?.W({wD:async()=>{await k.wD(n,Z);C()},
fE:()=>{}})})},iwi=async function(k){k=await XI7(k);
return!!k&&k.length>0},UJx=async function(k,U){if(U.length===0)return[];
const n=U.map(C=>g.Cd(C,"transfer")),Z=(await D6(k.S,"transfer",n)).filter(vT7).map(C=>g.Zd(C.key).entityId);
k=U.filter(C=>Z.indexOf(C)===-1);
if(k.length===0)return[];for(const C of k)await Pt(C);return k},CQV=async function(k,U,n,Z,C,r){let L="STREAM_TYPE_UNKNOWN";
n.video&&n.audio?(L="STREAM_TYPE_AUDIO_AND_VIDEO",cD("unexpected stream type")):n.video&&!n.audio?L="STREAM_TYPE_VIDEO":!n.video&&n.audio&&(L="STREAM_TYPE_AUDIO");const F=g.Cd(U,"offlineVideoStreams"),v={numBytesDownloaded:C.toFixed(),numTotalBytes:r.toFixed(),streamType:L,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(Z),itag:L==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(n.itag):void 0};await g.ar(k,{mode:"readwrite",TQ:!0},O=>{const w=I_(O,F,"offlineVideoStreams"),u=
I_(O,g.Cd(U,"transfer"),"transfer");return g.Wi.all([w,u]).then(([X,E])=>{if(!E)return e1(O,F).then(()=>{});
var V=nUE(X);X=Zwp(X,Z,v,F);const Q=g.TT(O,X,"offlineVideoStreams");nUE(X)>V&&(E.lastProgressTimeMs=Date.now().toString());V=[Q];E.offlineVideoStreams||(E.offlineVideoStreams=[]);E.offlineVideoStreams.indexOf(F)===-1&&(E.offlineVideoStreams.push(F),V.push(g.TT(O,E,"transfer")));return g.Wi.all(V)})})},rbx=async function(k,U){U=g.Cd(U,"offlineVideoStreams");
if((U=await Y7(k,U,"offlineVideoStreams"))&&U.streamsProgress){for(const n of U.streamsProgress)n.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",n.numTotalBytes!==n.numBytesDownloaded&&(n.numBytesDownloaded=n.numTotalBytes);await g.$J(k,U,"offlineVideoStreams")}},Zwp=function(k,U,n,Z){if(k&&k.streamsProgress){Z=k;
a:{U=`${U.itag};${U.xtags}`;var C=k.streamsProgress;for(let r=0;r<C.length;r++){const L=JSON.parse(C[r].formatStreamBytes);if(`${L.itag};${L.xtags}`===U){C[r]=n;n=C;break a}}C.push(n);n=C}Z.streamsProgress=n}else k={key:Z,streamsProgress:[n]};return k},nUE=function(k){if(k?.streamsProgress){let U=0;
k=k.streamsProgress;for(let n=0;n<k.length;n++){const Z=k[n];isNaN(Number(Z.numBytesDownloaded))?cD("stream progress bytes number invalid"):U+=Number(Z.numBytesDownloaded)}return U}return 0},$DY=async function(k){if(k.S){const U=k.S;
k.J.stop();await jT(k,"TRANSFER_STATE_PAUSED_BY_USER");const n=U?.key?g.Zd(U.key).entityId:"";n&&k.j&&await C3(n,k.j,k.B,"DOWNLOAD_STATE_PAUSED");const Z=await ST(k,n);J2E({videoId:n,y6:U,offlineModeType:Z})}else GR(k,"onTransferPausedByUser");f3(k);Mu(k)},pas=async function(k){if(k.S){k.J.stop();
await jT(k,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var U=k.S;(U=U?.key?g.Zd(U.key).entityId:"")&&k.j&&await C3(U,k.j,k.B,"DOWNLOAD_STATE_PAUSED");f3(k)}else GR(k,"onTransferPausedByNetwork")},y4=async function(k){if(k.S){k.J.start(108E5);
await jT(k,"TRANSFER_STATE_TRANSFERRING");var U=k.S;(U=U?.key?g.Zd(U.key).entityId:"")&&k.j&&await C3(U,k.j,k.B,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else GR(k,"onTransferStart")},LOV=async function(k,U,n){if(k.S){k.S.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await y4(k);
var Z=Date.now();Z-k.By>1E3&&(k.By=Z,await CQV(k.B,n.videoId,n.B,n.MP,n.bytesDownloaded,n.S),!k.D||k.D&&Z-k.dM>k.TJ)&&(k.dM=Z,Z=await ST(k,U),qrE({videoId:U,y6:k.S,offlineModeType:Z},n.bytesDownloaded,n.S));k.J.start(108E5)}else GR(k,`onTransferProgress: ${U}`)},vUY=async function(k){if(k.S){var U=k.S;
k.J.stop();if(U&&k.W){var n=Op(k.api.U(),U.cotn,k.W);await FO8(k,n)}await jT(k,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(n=U?.key?g.Zd(U.key).entityId:"")&&k.j&&await C3(n,k.j,k.B,"DOWNLOAD_STATE_COMPLETE");await rbx(k.B,n);var Z=await ST(k,n);ki({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:n,y6:U,offlineModeType:Z});f3(k);Mu(k)}else GR(k,"onTransferComplete")},Owb=async function(k){await ufs();
k=k.x$;var U=g.iT();U=Object.keys(U);await UJx(k,U)},gUb=async function(k){k=(await D6(k.B,"transfer")).filter(wY7).sort(u4p);
return k.length===0?void 0:k[0]},Abi=async function(k,U){if(!k.X){k.X=!0;
k.S=U;var n=g.Zd(k.S.key).entityId;if(k.S.transferState==="TRANSFER_STATE_TRANSFERRING"){var Z=await ST(k,n);ki({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:n,y6:k.S,offlineModeType:Z})}else k.S.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||k.S.transferRetryCount||k.S.hasLoggedFirstStarted||(Z=await ST(k,n),k.S.hasLoggedFirstStarted=!0,await XYO(k),qrE({videoId:n,y6:k.S,offlineModeType:Z},void 0,void 0,!0));await y4(k);n=null;try{n=await EUi(k,
U),k.W=n}catch(C){cD("error getting player response",C,U.cotn);await k.Kd("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}Z=Op(k.api.U(),U.cotn,n);await FO8(k,Z);Z.n2=await a__(Z.videoId);n=k.L;U=U.maximumDownloadQuality;Z.getPlayerResponse();g.n7(Z.videoId,2);n.j=2;n.B=!1;n.player?.dispose();n.player=n.api.D3(Z);n.player.Ze({localmediachange:n.yQ,signatureexpired:n.VL,statechange:n.J},n);n.C("html5_generate_content_po_token")&&n.player.Oz();U=n.m4(U);n.player.o_(g.de(U,U,!0,"m"),!1);n.player.A9(!1);
k.J.start(108E5)}},f3=function(k){k.S=void 0;
k.W=void 0;k.J.stop()},Mu=async function(k,U=!1){if(k.S)throw Error("Already downloading a video");
k.dM=0;k.X=!1;const n=await gUb(k);Iw2(k.V$,!n);n&&k.V.SB()?(U&&await new Promise(Z=>{g.D2(Z,1E3)}),await Abi(k,n)):!n&&k.S&&f3(k)},ST=async function(k,U){return(await Y7(k.B,g.Cd(U,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},dJV=async function(k){k.W&&(await sp(k.L,k.W.videoDetails.videoId),f3(k))},FO8=async function(k,U){try{(U.captionTracks.length||U.tS)&&!await iwi(U.videoId)&&await kr7(k.aQ,U)}catch(n){cD("Caption downloading error",n,U.cotn)}},XYO=
async function(k,U){if(k.S){var n=k.S;
await g.ar(k.B,{mode:"readwrite",TQ:!0},Z=>{const C=[g.TT(Z,n,"transfer")];U&&C.push(U(Z));return g.Wi.all(C)})}},EUi=async function(k,U){U=g.Zd(U.key).entityId;
U=g.Cd(U,"playbackData");k=await Y7(k.B,U,"playbackData");if(k?.playerResponseJson)return JSON.parse(k.playerResponseJson);throw Error("No PlayerResponse found");},jT=async function(k,U,n,Z){if(k.S){k.S.transferState=U;
k.S.failureReason=Z;try{await XYO(k,C=>n?qm(C,"offlineVideoStreams",k.S.offlineVideoStreams).then(r=>{for(const L of r)if(L&&L.streamsProgress)for(const F of L.streamsProgress)F.streamState=n;return J4(C,r.filter(L=>!!L),"offlineVideoStreams")}):g.Wi.resolve(void 0))}catch(C){C instanceof g.Pi&&C.type==="QUOTA_EXCEEDED"&&await k.Kd("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else GR(k,`saveTransferState: ${U}`)},GR=function(k,U){k.api.rM("woffle",{mcte:U});
cD("missing current transfer entity.")},V3_=function(k){const U=(k.S.transferRetryCount||0)<3;
U&&(k=k.S,k.transferRetryCount=(k.transferRetryCount||0)+1);return U},Hwp=async function(k,U="TRANSFER_FAILURE_REASON_UNKNOWN"){k.S||GR(k,`setTransferToFailed: ${U}`);
var n="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";U==="TRANSFER_FAILURE_REASON_NETWORK"?n="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":U==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(n="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await jT(k,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",U);lx(k.Y,{entityKey:k.S?.key,failureReason:n});n=k.S?g.Zd(k.S.key).entityId:"";const Z=await ST(k,n);k={videoId:n,y6:k.S,offlineModeType:Z};n={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};U&&(n.transferFailureReason=U,n.failureReason=eDp(U));ki(n,k)},wY7=function(k){return ct[k.transferState]!==void 0},u4p=function(k,U){const n=ct[k.transferState],Z=ct[U.transferState];
return n!==Z?n-Z:Number(k.enqueuedTimestampMs)-Number(U.enqueuedTimestampMs)},RFs=async function(k){g.LB(k.api,"onOrchestrationBecameLeader");
await k.Sa()},zFm=async function(k){const U=await g.Nj();
if(U){k.B=new hF_(U,k.api,k.j,k.S);var n=k.V(U);k.X=await j5x(U,n,k.j,k.S,k.k$);await bwV(k)}else cD("PES is undefined")},bwV=async function(k){if(k.B){k.B.S||await Mu(k.B);
k.k$.C("woffle_enable_main_downloads_library")&&await k.Wy();k.k$.C("html5_offline_playback_position_sync")&&(await k.By(),await k.pM(864E5));await k.refreshAllStaleEntities(43200,!0);await k.D();k.k$.C("html5_retry_downloads_for_expiration")&&await k.AQ();k.dM=g.ok(()=>{k.refreshAllStaleEntities(43200,!0);k.D()},9E5);
g.zW(g.Kr(),()=>k.yP());
var U=await g.Nj();await $dB(U);NMV(k.j)}else cD("transferManager is undefined")},QTO=async function(){const k=await g.Nj();
if(!k)return[];const U=Date.now()/1E3,n=await D6(k,"offlineVideoPolicy");for(const Z of n)Z.expirationTimestamp&&Number(Z.expirationTimestamp)<U&&(Z.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",Z.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await g.$J(k,Z,"offlineVideoPolicy"));return n.map(Z=>Z.key)},l0=async function(k,U,n,Z,C){var r=await g.Nj();
if(!r)return[];U=U.map(L=>{var F=g.Cd(L,n);F={actionType:Z,entityKey:F,actionMetadata:{...wW(),...C}};Z!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(F.actionMetadata.priority=0);L=new u0(n,L,F);return XW(L)});
r=UdV(r,U);pIB(k.j);return r},KO7=async function(k,U,n,Z){const C=[];
for(const r of U)if(!r.upToDate&&(!n||r.shouldAutoSyncMetadata)&&r.playlistId){U={};switch(Z){case "mainPlaylistEntity":U={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:r.checkInSeconds,autoSync:n}};break;case "musicPlaylist":U={musicPlaylistEntityActionMetadata:{autoSync:n}}}(U=await l0(k,[r.playlistId],Z,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",U))&&C.push(...U)}return C},TR8=async function(k,U){if(U.length){const n=wW();
g.jd(n,qu,{isEnqueuedForExpiredStreamUrlRefetch:!0});k.api.rM("qrd",{v:U.length});return l0(k,U,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",n)}return[]},$Jm=async function(k,U){const n=i0(U);
var Z=g.Zd(U.entityKey).entityId;let C=[];try{C=await aJE(k,Z),k.k$.C("woffle_enable_main_downloads_library")&&C?.length&&await hH(k.S,[U.entityKey])}catch(L){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.Pi&&L.type==="QUOTA_EXCEEDED"?(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):cD("Playlist add error"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
n,void 0,U,Z)}const r=[];k.k$.C("html5_offline_prevent_redownload_downloaded_video")&&(C=await vt(k.S,"mainVideoEntity",C));if(C?.length)for(const L of C)k=L.offlineVideoData,k?.videoId&&r.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k.videoId,"mainVideoEntity",Number(U.actionMetadata?.priority||0)+1,m9,xi(U,k,Z)));return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,r)},NRY=async function(k,U){const n=i0(U);
var Z=U.entityKey,C=g.Zd(Z).entityId,r=[],L=!1;C==="!*$_ALL_ENTITIES_!*$"?(L=!0,r=await D6(k.S,"mainPlaylistEntity")):(Z=await Y7(k.S,Z,"mainPlaylistEntity"))&&r.push(Z);if(!r?.length)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);var F=g.e(U.actionMetadata,pY7);Z=F?.nextAutoRefreshIntervalSeconds;const v=F?.autoSync;let O=[],w=!0;F=!0;let u=!1;if(L||v!==!1){try{O=await CwV(0,!!v,!0,r)}catch(Q){Q instanceof Error&&Q.message==="No data"?C==="!*$_ALL_ENTITIES_!*$"?await Ht(k.S,U,k.j,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await V4(C,k.S,U,k.j):Q instanceof Error&&Q.message==="Empty response body"&&cD(Q.message)}if(!O.length||!L&&O[0].playlistId!==C)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)}if(L){U=[];for(var X of O)X.upToDate||v&&!X.shouldAutoSyncMetadata||!X.playlistId||U.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",X.playlistId,"mainPlaylistEntity",0,m9,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:X.checkInSeconds,autoSync:v}}));
return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,U)}O.length&&(X=O[0],u=!!X.upToDate,v&&(w=X.shouldAutoSyncMetadata??!0,F=X.shouldAutoSyncVideos??!0,X.checkInSeconds&&(Z=X.checkInSeconds)));if(u||!w)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);X=[];r=r[0];L=r.downloadState?await Y7(k.S,r.downloadState,"mainPlaylistDownloadStateEntity"):void 0;L=L?.addedTimestampMillis?String(L.addedTimestampMillis):void 0;try{X=await aJE(k,C,L,Z)}catch(Q){if(Q instanceof Error&&Q.message===
"No data for playlist")await V4(C,k.S,U,k.j);else if(Q instanceof Error&&Q.message==="Empty response body for playlist")cD(Q.message);else return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",Q instanceof g.Pi&&Q.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",C="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,U,C)}if(!F)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
n);k=[];Z=new Map;if(X?.length)for(var E of X)F=E.offlineVideoData,F?.videoId&&Z.set(F.videoId,F);E=new Map;F=[];if(r?.videos?.length)for(var V of r.videos)if(r=JSON.parse(g.Zd(V).entityId).videoId)Z.has(r)?(E.set(r,Z.get(r)),Z.delete(r)):F.push(r);V=Number(U.actionMetadata?.priority||0)+1;for(const [Q,p]of Z.entries())k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",Q,"mainVideoEntity",V,m9,xi(U,p,C)));for(const [Q,p]of E.entries())k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",Q,"mainVideoEntity",
V,m9,xi(U,p,C)));for(const Q of F)k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",Q,"mainVideoEntity",0,m9,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:C}}));return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,k)},t3V=async function(k,U){const n=i0(U);
try{const Z=g.Zd(U.entityKey).entityId;Z==="!*$_ALL_ENTITIES_!*$"?await Ht(k.S,U,k.j,U.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await V4(Z,k.S,U,k.j),k.k$.C("woffle_enable_main_downloads_library")&&await b0(k.S,U.entityKey))}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
n)},aJE=async function(k,U,n,Z){U=await tH([U]);
const {mainPlaylistEntity:C,Yh:r}=await IJV(k,U[0],n,Z);k=Ddi(C,r?.avatar);try{await AH(k)}catch(L){L instanceof Error&&L.message==="Failed to fetch"&&cD(L.message)}return U[0].videos},xi=function(k,U,n){U={offlineVideoData:U,
playlistId:n};if(k=g.e(k.actionMetadata,pY7))U.maximumDownloadQuality=k.maximumDownloadQuality;return{mainVideoEntityActionMetadata:U}},IJV=async function(k,U,n,Z){const C=Date.now().toString();
n||(n=C);var r=U.videos;const L=U.playlistId,F=[],v=[];if(r)for(const X of r){r=X.offlineVideoData;if(!r||!r.videoId)throw cD("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");r=r.videoId;r={id:g.Cd(JSON.stringify({videoId:r,playlistId:L}),"mainPlaylistVideoEntity"),video:g.Cd(r,"mainVideoEntity")};F.push(r);v.push(r.id)}let O;const w={key:g.Cd(L,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:n,lastSyncedTimestampMillis:C},u={key:g.Cd(L,"mainPlaylistEntity"),
playlistId:L,videos:v,title:U.title,thumbnailStyleData:qvV(U),visibility:Jb2(U),downloadState:w.key};U.channel&&(n=U.channel.offlineChannelData,O=eFV(g.Cd(L,"ytMainChannelEntity"),n),u.channelOwner=O.id);u?.entityMetadata?(u.entityMetadata.offlineLastModifiedTimestampSeconds=U.lastModifiedTimestamp,Z&&(u.entityMetadata.nextAutoRefreshIntervalSeconds=String(Z))):u&&(u.entityMetadata={nextAutoRefreshIntervalSeconds:Z?String(Z):void 0,offlineLastModifiedTimestampSeconds:U.lastModifiedTimestamp});try{await g.ar(k.S,
{mode:"readwrite",TQ:!0},X=>{var E=g.TT(X,u,"mainPlaylistEntity");const V=g.TT(X,w,"mainPlaylistDownloadStateEntity");E=[E,V];for(const Q of F)E.push(g.TT(X,Q,"mainPlaylistVideoEntity"));O&&E.push(g.TT(X,O,"ytMainChannelEntity"));return g.Wi.all(E)})}catch(X){throw cD("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:u,Yh:O,K$$:F}},qvV=function(k){const U=[];
var n=k.videos;n&&n.length>0&&U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:n[0].offlineVideoData.thumbnail}}});if((k=k.additionalMetadadatas)&&k.length>0)for(const Z of k)switch(k=Z.offlineBundleItemPlaylistData,n={collageThumbnail:{coverThumbnail:k?.coverThumbnail}},k?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:n});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:n});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:n});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:n})}return U},Jb2=function(k){switch(k.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},eFV=function(k,U){return{id:k,
channelId:U.channelId,title:U.title,avatar:U.thumbnail}},sTp=async function(k,U){const n=i0(U);
var Z=g.Zd(U.entityKey).entityId;const C=g.e(U.actionMetadata,kf),r=!C?.playlistId;try{await BRx(k,Z,void 0,C?.offlineVideoData,r)}catch(L){return Z="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.Pi&&L.type==="QUOTA_EXCEEDED"&&(Z="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,Z,U)}k=Number(U.actionMetadata?.priority||
0)+1;U=(U=g.e(U.actionMetadata,kf))?{playbackDataActionMetadata:{maximumDownloadQuality:U.maximumDownloadQuality}}:void 0;Z=IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",Z,"playbackData",k,PQb,U);return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,[Z])},Yv8=async function(k,U){const n=i0(U),Z=g.Zd(U.entityKey).entityId;
var C=await Y7(k.S,U.entityKey,"mainVideoEntity"),r=C?await Y7(k.S,C.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!C||!r)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);let L;try{await BRx(k,Z,r.addedTimestampMillis,g.e(U.actionMetadata,kf)?.offlineVideoData),C=1,C=Number(U.actionMetadata?.priority||0)+1,L=IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",Z,"playbackData",C,PQb)}catch(F){if(F instanceof Error&&F.message==="No data"){C=await zR(k.S,Z);if(r=g.e(U.actionMetadata,
kf)?.playlistId)C.playlistId=r;C.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await dW(Z,k.S,U,k.j,C)}else if(F instanceof Error&&F.message==="Empty response body")cD(F.message);else return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",F instanceof g.Pi&&F.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
n,void 0,k,U)}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,L?[L]:void 0)},DJE=async function(k,U){const n=i0(U);
try{const Z=g.Zd(U.entityKey).entityId;if(Z==="!*$_ALL_ENTITIES_!*$")await Ht(k.S,U,k.j,U.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const C=await zR(k.S,Z),r=g.e(U.actionMetadata,kf)?.playlistId;r&&(C.playlistId=r);C.offlineDeleteReason=U.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await dW(Z,k.S,U,k.j,C);k.k$.C("woffle_enable_main_downloads_library")&&await b0(k.S,U.entityKey)}}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},BRx=async function(k,U,n,Z,C){Z||(Z=(await n2E([U]))[0]);
const {mainVideoEntity:r,channelEntity:L}=await oU_(k,Z,n,C);try{const F=FW(r.thumbnail),v=FW(L.avatar);await AH(F.concat(v))}catch(F){F instanceof Error&&F.message==="Failed to fetch"&&cD(F.message)}},oU_=async function(k,U,n,Z){n||(n=Date.now().toString());
const C=U.channel?.offlineChannelData,r={id:g.Cd(U.videoId,"ytMainChannelEntity"),channelId:C.channelId,title:C.title,avatar:C.thumbnail},L={key:g.Cd(U.videoId,"mainVideoDownloadStateEntity"),playbackData:g.Cd(U.videoId,"playbackData"),addedTimestampMillis:n,videoDownloadContextEntity:g.Cd(U.videoId,"videoDownloadContextEntity")},F={key:g.Cd(U.videoId,"videoPlaybackPositionEntity"),videoId:U.videoId,lastPlaybackPositionSeconds:"0"};let v;k.k$.C("html5_offline_playback_position_sync")&&(v={playbackPosition:F.key});
n=g.Cd(U.videoId,"mainVideoEntity");const O={key:n,videoId:U.videoId,title:U.title,thumbnail:U.thumbnail,localizedStrings:{viewCount:U.shortViewCountText},userState:v,lengthSeconds:U.lengthSeconds?Number(U.lengthSeconds):void 0,publishedTimestampMillis:U.publishedTimestamp?(Number(U.publishedTimestamp)*1E3).toString():void 0,formattedDescription:U.description,owner:r.id,downloadState:L.key};let w,u;k.k$.C("woffle_enable_main_downloads_library")&&Z&&(Z=await y2p(k.S,[n]))&&(w=Z.mainDownloadsLibraryEntity,
u=Z.mainDownloadsListEntity);let X;X={key:g.Cd(U.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.jd(L,PKB,X);await g.ar(k.S,{mode:"readwrite",TQ:!0},E=>{var V=g.TT(E,r,"ytMainChannelEntity"),Q=g.TT(E,L,"mainVideoDownloadStateEntity");const p=g.TT(E,O,"mainVideoEntity");V=[V,Q,p];k.k$.C("html5_offline_playback_position_sync")&&(Q=g.TT(E,F,"videoPlaybackPositionEntity"),V.push(Q));w&&(Q=g.TT(E,w,"mainDownloadsLibraryEntity"),V.push(Q));u&&(Q=g.TT(E,u,"mainDownloadsListEntity"),
V.push(Q));X&&(E=g.TT(E,X,"downloadStatusEntity"),V.push(E));return g.Wi.all(V)});
return{mainVideoEntity:O,channelEntity:r}},jTi=async function(k,U){const n=i0(U),Z=[];
var C=await Bt.getInstance();let r,L;C&&(r=await C.get("sdois"),L=await C?.get("lmqf"));try{if(r===void 0)throw Error("prefStorage or opt-in state is undefined");C=[];r||(C=await MtY(k.S),C.reverse());if(C.length)for(const O of C){if(!O)continue;const w=g.Zd(O).entityId,u=await zR(k.S,w);u.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await dW(w,k.S,{entityKey:O,actionType:U.actionType},k.j,u)}const F=await LIV(r,L??"SD");await jJ7(F);const v=fw_(F);k.k$.C("woffle_enable_main_downloads_library")&&
(r||await b0(k.S,g.CO),await hH(k.S,[g.CO]));if(v?.length)for(const O of v){const w=O.actionType,u=O.entityKey,X=O.actionMetadata;if(w&&u&&X&&!g.e(X,WOs)){w==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(X.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const E=g.e(O.actionMetadata,kf);E&&(E.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",O.actionMetadata={...O.actionMetadata,mainVideoEntityActionMetadata:E});Z.push(O)}}}catch(F){return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",F instanceof g.Pi&&F.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,k,U)}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,Z)},Sv7=async function(k,U=43200,n=!0){if(!k.L.SB())return[];
let Z=[];try{Z=await CwV(U,n,!1)}catch(C){C instanceof Error&&C.message==="No data"||C instanceof Error&&C.message==="Empty response body"&&cD(C.message)}return KO7(k,Z,n,"mainPlaylistEntity")},GrY=async function(k,U,n,Z=!1){let C=[];
if(!await rMY()&&!Z)return[];n=await FIY(U,n);if(!n?.length)return[];U={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const L of n){n=L.actionType;var r=L.entityKey;Z=L.actionMetadata;n&&r&&Z&&!g.e(Z,WOs)&&(n==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(Z.offlineLoggingData=U),{entityId:r}=g.Zd(r),n=await l0(k,[r],"mainVideoEntity",n,Z),C=C.concat(n))}return C},M32=async function(k,U){const n=i0(U);
var Z=g.Zd(U.entityKey).entityId;let C=[];try{C=await fJV(k,Z),C?.length&&await aR(k.S,U.entityKey)}catch(L){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.Pi&&L.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,U,Z)}const r=[];C=await vt(k.S,"musicTrack",C);if(C.length)for(const L of C)k=
L.offlineVideoData,k?.videoId&&r.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k.videoId,"musicTrack",Number(U.actionMetadata?.priority||0)+1,i3,p3(U,k,Z)));return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,r)},ybE=async function(k,U){const n=i0(U);
var Z=U.entityKey,C=g.Zd(Z).entityId,r=[],L=!1;C==="!*$_ALL_ENTITIES_!*$"?(L=!0,r=await D6(k.S,"musicAlbumRelease")):(Z=await Y7(k.S,Z,"musicAlbumRelease"))&&r.push(Z);if(!r?.length)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);if(L){U=[];for(var F of r){var v=g.Zd(F.id).entityId;U.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",v,"musicAlbumRelease",0,i3))}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,U)}F=[];r=r[0];L=void 0;r.downloadMetadata&&(L=await Y7(k.S,
r.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),L=Number(L?.addedTimestampMillis??"0")/1E3);try{F=await fJV(k,C,L?.toString())}catch(u){if(u instanceof Error&&u.message==="No data")await K3(C,"musicAlbumRelease",k.S,U,k.j);else if(u instanceof Error&&u.message==="Empty response body")cD(u.message);else return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",v="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",u instanceof g.Pi&&u.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
v="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,U,v)}k=[];C=new Map;if(F?.length)for(var O of F)F=O.offlineVideoData,F?.videoId&&C.set(F.videoId,F);O=new Map;F=[];if(r?.tracks?.length)for(var w of r.tracks)if(r=g.Zd(w).entityId)C.has(r)?(O.set(r,C.get(r)),C.delete(r)):F.push(r);w=Number(U.actionMetadata?.priority||0)+1;for(const [u,X]of C.entries())k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",u,"musicTrack",w,i3,p3(U,X)));for(const [u,
X]of O.entries())k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",u,"musicTrack",w,i3,p3(U,X)));for(v of F)k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",v,"musicTrack",0,i3));return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,k)},cb7=async function(k,U){const n=i0(U);
try{const Z=g.Zd(U.entityKey).entityId;Z==="!*$_ALL_ENTITIES_!*$"?await TR(k.S,U,k.j):(await K3(Z,"musicAlbumRelease",k.S,U,k.j),await $i(k.S,U.entityKey))}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},fJV=async function(k,U,n){U=await tH([U]);
k=await lJB(k,U[0],n);k=FW(k.thumbnailDetails);await AH(k);return U[0].videos},lJB=async function(k,U,n){var Z=U.additionalMetadadatas;
let C=void 0;if(Z&&Z.length>0)for(var r of Z)if(r.offlineMusicPlaylistData){C=r.offlineMusicPlaylistData;break}Z=U.playlistId;const {rK:L,SQ:F}=klp(U);n=n?(Number(n)*1E3).toString():Date.now().toString();r=U.lastModifiedTimestamp?(Number(U.lastModifiedTimestamp)*1E3).toString():"0";const v={id:g.Cd(Z,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:F,lastModifiedTimestampMillis:r,addedTimestampMillis:n,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},O={id:g.Cd(Z,"musicAlbumRelease"),
title:U.title,audioPlaylistId:Z,trackCount:U.totalVideoCount,tracks:L,downloadMetadata:v.id};C&&(O.thumbnailDetails=C.albumHqThumbnail??C.albumArtistThumbnail,O.artistDisplayName=C.albumArtistDisplayName,O.releaseDate=C.albumReleaseDate,O.contentRating={explicitType:C.albumReleaseExplicitType},O.releaseType=C.albumReleaseType);await g.ar(k.S,{mode:"readwrite",TQ:!0},w=>{const u=g.TT(w,O,"musicAlbumRelease");w=g.TT(w,v,"musicAlbumReleaseDownloadMetadataEntity");return g.Wi.all([u,w])});
return O},xJp=async function(k,U){const n=i0(U);
var Z=g.Zd(U.entityKey).entityId;let C=[];try{C=await mJp(k,Z),C?.length&&await aR(k.S,U.entityKey)}catch(L){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",L instanceof g.Pi&&L.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,U,Z)}const r=[];C=await vt(k.S,"musicTrack",C);if(C.length)for(const L of C)k=
L.offlineVideoData,k?.videoId&&r.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",k.videoId,"musicTrack",Number(U.actionMetadata?.priority||0)+1,UA,p3(U,k,Z)));return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,r)},k3b=async function(k,U){const n=i0(U);
var Z=U.entityKey,C=g.Zd(Z).entityId,r=[],L=!1;C==="!*$_ALL_ENTITIES_!*$"?(L=!0,r=await D6(k.S,"musicPlaylist")):(Z=await Y7(k.S,Z,"musicPlaylist"))&&r.push(Z);if(!r?.length)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);const F=g.e(U.actionMetadata,ilm)?.autoSync;let v=[],O=!0;Z=!0;let w=!1;var u=void 0;if(L||F!==!1){try{v=await v2V(0,!!F,!0,r)}catch(p){p instanceof Error&&p.message==="No data"?C==="!*$_ALL_ENTITIES_!*$"?await TR(k.S,U,k.j):await K3(C,"musicPlaylist",k.S,U,k.j):p instanceof
Error&&p.message==="Empty response body"&&cD(p.message)}if(!v.length||!L&&v[0].playlistId!==C)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)}if(L){U=[];for(var X of v)X.upToDate||F&&!X.shouldAutoSyncMetadata||!X.playlistId||U.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",X.playlistId,"musicPlaylist",0,UA,{musicPlaylistEntityActionMetadata:{autoSync:F}}));return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,U)}v.length&&(X=v[0],w=!!X.upToDate,F&&(O=X.shouldAutoSyncMetadata??
!0,Z=X.shouldAutoSyncVideos??!0,X.checkInSeconds&&(u=X.checkInSeconds)));if(w||!O)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);X=[];r=r[0];L=void 0;r.downloadMetadata&&(L=await Y7(k.S,r.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),L=Number(L?.addedTimestampMillis??"0")/1E3);try{X=await mJp(k,C,L?.toString(),u)}catch(p){if(p instanceof Error&&p.message==="No data")await K3(C,"musicPlaylist",k.S,U,k.j);else if(p instanceof Error&&p.message==="Empty response body")cD(p.message);
else{U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var E="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";p instanceof g.Pi&&p.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",E="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,U,E)}}if(!Z)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);k=[];C=new Map;if(X?.length)for(var V of X)Z=V.offlineVideoData,Z?.videoId&&
C.set(Z.videoId,Z);V=new Map;Z=[];if(r?.tracks?.length)for(var Q of r.tracks)if(u=g.Zd(Q).entityId)C.has(u)?(V.set(u,C.get(u)),C.delete(u)):Z.push(u);Q=Number(U.actionMetadata?.priority||0)+1;for(const [p,I]of C.entries())k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",p,"musicTrack",Q,UA,p3(U,I)));for(const [p,I]of V.entries())k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",p,"musicTrack",Q,UA,p3(U,I)));for(E of Z)k.push(IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",E,"musicTrack",0,UA));
return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,k)},i1m=async function(k,U){const n=i0(U);
try{const Z=g.Zd(U.entityKey).entityId;Z==="!*$_ALL_ENTITIES_!*$"?await TR(k.S,U,k.j):(await K3(Z,"musicPlaylist",k.S,U,k.j),await $i(k.S,U.entityKey))}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},mJp=async function(k,U,n,Z){U=await tH([U]);
k=await Uwp(k,U[0],n,Z);k=FW(k.thumbnailDetails);await AH(k);return U[0].videos},Uwp=async function(k,U,n,Z){const C=U.playlistId,{rK:r,
SQ:L}=klp(U);n=n?(Number(n)*1E3).toString():Date.now().toString();const F=U.lastModifiedTimestamp?(Number(U.lastModifiedTimestamp)*1E3).toString():"0",v={id:g.Cd(C,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:L,lastModifiedTimestampMillis:F,addedTimestampMillis:n,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},O={id:g.Cd(C,"musicPlaylist"),title:U.title,playlistId:C,thumbnailDetails:U.thumbnail,visibility:nxx(U),trackCount:U.totalVideoCount,tracks:r,downloadMetadata:v.id};Z&&(O?.entityMetadata?
O.entityMetadata.nextAutoRefreshIntervalSeconds=String(Z):O&&(O.entityMetadata={nextAutoRefreshIntervalSeconds:String(Z)}));await g.ar(k.S,{mode:"readwrite",TQ:!0},w=>{const u=g.TT(w,O,"musicPlaylist");w=g.TT(w,v,"musicPlaylistDownloadMetadataEntity");return g.Wi.all([u,w])});
return O},nxx=function(k){switch(k.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},rnE=async function(k,U){const n=i0(U);
var Z=g.Zd(U.entityKey).entityId;const C=g.e(U.actionMetadata,ne);try{await Z1_(k,Z,void 0,C?.track,C?.albumRelease),C?.playlistId||await aR(k.S,U.entityKey)}catch(r){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",r instanceof g.Pi&&r.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",Z="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,
void 0,U,Z)}k=(k=g.e(U.actionMetadata,ne))?{playbackDataActionMetadata:{maximumDownloadQuality:k.maximumDownloadQuality}}:void 0;U=IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",Z,"playbackData",Number(U.actionMetadata?.priority||0)+1,CWm,k);return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,[U])},LYB=async function(k,U){const n=i0(U),Z=g.Zd(U.entityKey).entityId;
var C=await Y7(k.S,U.entityKey,"musicTrack");const r=C?await Y7(k.S,C.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!C||!r)return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n);let L;C=g.e(U.actionMetadata,ne);try{await Z1_(k,Z,r.addedTimestampMillis,C?.track,C?.albumRelease),L=IR("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",Z,"playbackData",Number(U.actionMetadata?.priority||0)+1,CWm)}catch(F){if(F instanceof Error&&F.message==="No data")await Q4(Z,k.S,U,k.j);else if(F instanceof
Error&&F.message==="Empty response body")cD(F.message);else return k="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",F instanceof g.Pi&&F.type==="QUOTA_EXCEEDED"&&(k="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,k,U)}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n,L?[L]:void 0)},FYV=async function(k,
U){const n=i0(U);
try{const Z=g.Zd(U.entityKey).entityId;Z==="!*$_ALL_ENTITIES_!*$"?await TR(k.S,U,k.j):(await Q4(Z,k.S,U,k.j),await $i(k.S,U.entityKey))}catch(Z){return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",n,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eT("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",n)},Z1_=async function(k,U,n,Z,C){Z||(Z=(await n2E([U]))[0],Z=xdO(Z));
const {musicTrackEntity:r,pv:L}=await vx2(k,Z,U,C,n);k=FW(r.thumbnailDetails);U=[];L&&(U=FW(L.thumbnailDetails));await AH(k.concat(U))},vx2=async function(k,U,n,Z,C){C||(C=Date.now().toString());
const r={id:g.Cd(n,"musicTrackDownloadMetadataEntity"),playbackData:g.Cd(n,"playbackData"),addedTimestampMillis:C,videoDownloadContextEntity:g.Cd(n,"videoDownloadContextEntity")};Z&&(U.albumRelease=Z.id);await g.ar(k.S,{mode:"readwrite",TQ:!0},L=>{const F=[];var v=g.TT(L,r,"musicTrackDownloadMetadataEntity");F.push(v);v=g.TT(L,U,"musicTrack");F.push(v);Z&&(L=g.TT(L,Z,"musicAlbumRelease"),F.push(L));return g.Wi.all(F)});
await C3(n,"musicTrackDownloadMetadataEntity",k.S,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:U,pv:Z}},O1m=async function(k,U=43200,n=!0){if(!k.L.SB())return[];
let Z=[];try{Z=await v2V(U,n,!1)}catch(C){}return KO7(k,Z,n,"musicPlaylist")},wPY=function(k){let U;
k=g.e(k.getWatchNextResponse()?.currentVideoEndpoint,g.A$);k?.playlistId&&(U=k.playlistId);return U},uS8=async function(k,U){const n=U.clientPlaybackNonce,Z={cpn:n,
offlineSourceVisualElement:g.bf(U.Y||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};U.B&&(Z.videoFmt=Number(U.B.itag));U.J&&(Z.audioFmt=Number(U.J.itag));const C=wPY(U);var r;if(r=C&&U.videoId)U=U.videoId,r=await (C!=="PPSV"?Promise.resolve(!1):k.S.x$(U));r&&(Z.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");k.B=n;g.Rt("offlinePlaybackStarted",Z)};
g.wX.prototype.D3=g.nz(42,function(k){return this.app.D3(k)});
g.xG.prototype.D3=g.nz(41,function(k){return g.HoB(this,9,k)});
var Ols=["browse","music/browse","streaming_browse","unplugged/browse"],E2V=["offline/playlist_sync_check"],UDB=["offline"],wai=["offline/offline_video_playback_position_sync"],g2_=["offline/get_playback_data_entity"],Bt=class{constructor(k){this.token=k}static async getInstance(){return new Promise(k=>{g.uh().then(U=>{U?(Bt.instance||(Bt.instance=new Bt(U)),k(Bt.instance)):k(void 0)})})}async get(k){if(k=await (await o_(this.token)).get("prefs",k)){var U=(0,g.D)();
return k.expirationTimestampMs<=U?void 0:k.value}}async set(k,U,n=31536E3){const Z=(0,g.D)();k={key:k,value:U,expirationTimestampMs:Z+n*1E3};await (await o_(this.token)).put("prefs",k)}async remove(k){await (await o_(this.token)).delete("prefs",k)}},Sri=new g.x("elementsCommand");var RR=new g.x("entityBatchUpdate");var PKB=new g.x("downloadStatusEntity");var pY7=new g.x("mainPlaylistEntityActionMetadata");var kf=new g.x("mainVideoEntityActionMetadata");var ilm=new g.x("musicPlaylistEntityActionMetadata");var ne=new g.x("musicTrackEntityActionMetadata");var G6B=new g.x("offlineOrchestrationActionCommand");var WOs=new g.x("localImageEntityActionMetadata");var qu=new g.x("playbackDataActionMetadata");var JMB=new g.x("transferEntityActionMetadata");var Q5b=new g.x("videoPlaybackPositionEntityActionMetadata");var HG8=class{constructor(){this.S=new Map}},j1;new g.A6;new g.A6;var QJE=class{constructor(){this.locks=navigator.locks}request(k,U={},n){return this.locks.request(k,U,Z=>n(Z))}};var fx=g.Vs.caches,Gh,Mm,gx8=class{open(k){return fx.open(S1(k))}has(k){return fx.has(S1(k))}delete(k){return fx.delete(S1(k))}async match(k,U){var n=await this.keys();for(const Z of n)if(n=await (await this.open(Z)).match(k,U))return n}},awi=class extends gx8{async keys(){const k=[],U=g.Hi("CacheStorage keys");var n=await fx.keys();for(const Z of n){n=Z.indexOf(":");const {rp:C,datasyncId:r}=n===-1?{rp:Z}:{rp:Z.substring(0,n),datasyncId:Z.substring(n+1)};r===U&&k.push(C)}return k}};var XPm=class extends g.ca{constructor(k){super();this.api=k;this.iZ={wn$:()=>this.S,
emg:()=>this.B};
typeof g.Vs.BroadcastChannel!=="undefined"&&(this.S=new g.Vs.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.Hi()}`),this.S.onmessage=this.j.bind(this),this.B=new g.Vs.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.Hi()}`),this.B.onmessage=this.J.bind(this))}j(k){g.LB(this.api,"onOfflineOperationFailure",k.data)}J(k){this.api.publish("offlinetransferpause",k.data)}Q$(){this.S?.close();this.B?.close()}};var Exm=class{constructor(k,U,n){this.X=k;this.D=U;this.visibility=n;this.W=this.L=this.V=this.j=this.S=!1;this.J=new g.iX(()=>{this.GW()});
this.iZ={zD:()=>this.B,
GW:()=>{this.GW()},
Aa$:()=>this.J};
this.visibility.subscribe("visibilitystatechange",()=>{this.fD()})}fD(){this.S&&me(this)}GW(){this.B&&this.B.resolve();
this.j=this.S=!1;this.D()}};var l_7=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var u0=class{constructor(k,U,n,Z,C=U,r,L,F,v,O,w){this.entityType=k;this.actionId=U;this.action=n;this.parentActionId=Z;this.rootActionId=C;this.childActionIds=r;this.prereqActionId=L;this.postreqActionIds=F;this.hasChildActionFailed=O;this.retryScheduleIndex=0;this.S=w||Date.now();this.retryScheduleIndex=v||0}};var WrO="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var mdE="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var Z$=class{constructor(k){this.S=k}},eT=class{constructor(k,U,n,Z,C,r){this.status=k;this.S=U;this.J=n;this.B=Z;this.j=C;this.downloadState=r}};var An_=class extends Z${constructor(k,U,n){super(k);this.S=k;this.k$=U;this.j=n}B(k){return Up(k)?HlV(this,k):n3(k)?bl7(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var dw8=class extends Z${constructor(k,U){super(k);this.S=k;this.k$=U}B(k){return n3(k)?z6E(this,k):BM7(k)?KIY(this,k):Zl(k)?TVO(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var VLs=class{constructor(k,U){this.api=k;this.S=U;this.logger=new g.fQ("woffle");this.B=!1;this.iZ={m4:this.m4}}async J(k){if(k.state.S(128)){const U=k.state.WS;k=U?.errorCode;k=k==="net.connect"&&U?.DB===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":k?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.Kd(this.player.getVideoData().videoId,k)}}async Kd(k,U){this.B||(this.B=!0,U==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?Yi(this,k,!1,!0):(await sp(this,k),
g.n7(k,4),await this.S.Kd(U)))}yQ(k){k.status===2?(k.status!==this.j&&(y4(this.S),g.n7(k.videoId,2)),k.tO&&LOV(this.S,k.videoId,k.tO)):k.status===4?(sp(this,k.videoId),this.Kd(k.videoId,k.wl?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):k.status===1&&vUY(this.S);this.j=k.status;g.LB(this.api,"localmediachange",{videoId:k.videoId,status:k.status})}async VL(){if(!this.B){this.B=!0;var k=this.player.getVideoData().videoId;await sp(this,k);await this.S.VL()}}m4(k){switch(k){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}C(k){return this.api.U().C(k)}};var H1V=class extends Z${constructor(k,U){super(k);this.S=k;this.k$=U}B(k){return Up(k)?to7(this,k):n3(k)?I_E(this,k):BM7(k)?qFx(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var Rlm=class{constructor(){this.actions=[]}S(k,U){let n=k.action.actionMetadata.priority-U.action.actionMetadata.priority;n===0&&(k.S<U.S?n=-1:k.S>U.S&&(n=1));return n}};var DD7=class extends g.ca{constructor(k,U,n,Z,C){super();this.B=k;this.SE=U;this.dM=n;this.L=Z;this.k$=C;this.S=new Rlm;this.V=new g.p$;this.j=new g.iX(()=>{this.retry()});
this.X=NaN;this.W=!1;this.iZ={C0L:()=>this.S,
cU:()=>this.V,
Rm$:()=>this.j,
retry:()=>this.retry()};
g.K(this,this.j);this.D=this.B.observe(this.Y.bind(this))}Q$(){this.D&&this.D();super.Q$()}createAction(k,U){const n=g.Zd(k.entityKey).entityType,Z=g.VP(16);return new u0(n,Z,k,U.actionId,U.rootActionId)}async Y(k){if(!this.LN()){var U=k.offlineOrchestrationActionWrapperEntity??new Set;k=[];for(var n of U)({entityId:U}=g.Zd(n)),YFV(this.S,U)||k.push(n);n=await yMi(this,k);await Wt(this,n)}}async retry(){await xD7(this)}};var hlm=class{constructor(k){this.y$=k;this.S=void 0}async wD(k,U=!0){if(this.S){var n=[],Z=g.X1(this.S.S,U),C=[];for(let r=0;r<Z.length;r++)U=this.S.V(Z[r],"json3"),U=g.r0(U,{withCredentials:!0,format:"RAW"},3,500).then(L=>{L={metadata:g.Y5(Z[r]),trackData:L.xhr.responseText};C.push(L)}).U0(L=>{cD("Caption fetch error",L)}),n.push(U);
await CKV(n);try{await gTV(k,C)}catch(r){cD("Caption DB transaction error",r)}}}};var b1p=class extends g.ca{constructor(k){super();this.S=k;this.B=this.S.observe(this.j.bind(this))}Q$(){this.B&&this.B();super.Q$()}async j(k){var U=k.transfer??new Set;k=[];for(const n of U)({entityId:U}=g.Zd(n)),k.push(U);k.length!==0&&await UJx(this,k)}};var hF_=class extends g.ca{constructor(k,U,n,Z){super();this.B=k;this.api=U;this.V$=n;this.Y=Z;this.V=new g.p$;this.J=new g.iX(()=>{this.S&&this.S.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.V.SB()&&((this.S.transferRetryCount||0)<3?Yi(this.L,this.W,!1,!1):sp(this.L,this.W.videoDetails.videoId),this.Kd("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.dM=this.By=0;this.D=this.X=!1;this.TJ=g.ve(this.api.U().experiments,"html5_transfer_processing_logs_interval");this.IQ=new g.HW(this);this.iZ={NxL:()=>this.J,
Ja8:()=>this.Y,
cU:()=>this.V};
this.SE=this.B.observe(this.pN.bind(this));this.L=new VLs(U,this);this.aQ=new hlm(U);this.x$=new b1p(this.B);this.eE=this.V.listen("publicytnetworkstatus-online",this.ul.bind(this));this.Wy=this.V.listen("publicytnetworkstatus-offline",this.Xo.bind(this));this.D=this.api.U().C("html5_less_transfer_processing_logs");g.K(this,this.IQ);this.IQ.K(U,"offlinetransferpause",this.uL);if(g.kD(this.api.U()))this.j="mainVideoDownloadStateEntity";else if(g.mN(this.api.U())||g.QC(this.api.U()))this.j="musicTrackDownloadMetadataEntity"}Q$(){this.SE&&
this.SE();this.x$.dispose();this.J.dispose();this.eE&&g.Hz(this.V.iW,this.eE);this.Wy&&g.Hz(this.V.iW,this.Wy);super.Q$()}async uL(k){const U=g.Cd(k,"transfer");if(this.S&&U===this.S.key)Yi(this.L,this.W,!0),this.J.stop();else{const n=await g.ar(this.B,{mode:"readwrite",TQ:!0},Z=>I_(Z,U,"transfer").then(C=>{if(C&&C.transferState!=="TRANSFER_STATE_COMPLETE"&&C.transferState!=="TRANSFER_STATE_FAILED")return C.transferState="TRANSFER_STATE_PAUSED_BY_USER",g.TT(Z,C,"transfer").then(()=>C)}));
if(n){k&&this.j&&await C3(k,this.j,this.B,"DOWNLOAD_STATE_PAUSED");const Z=await ST(this,k);J2E({videoId:k,y6:n,offlineModeType:Z})}}}Xo(){if(this.S&&this.W){Yi(this.L,this.W,!1);const k=this.S,U=k?.key?g.Zd(k.key).entityId:"";U&&this.j&&(new Promise((n,Z)=>{C3(U,this.j,this.B,"DOWNLOAD_STATE_PAUSED").catch(C=>{Z(C)})})).catch(n=>{cD("Download state setting error",n)})}this.J.stop()}ul(){this.S?Abi(this,this.S):Mu(this)}async pN(k){if(this.S&&(this.S.transferState!=="TRANSFER_STATE_COMPLETE"&&this.S.transferState!==
"TRANSFER_STATE_FAILED"&&k.transfer&&k.transfer.has(this.S.key)&&((this.S=await Y7(this.B,this.S.key,"transfer"))||await dJV(this)),this.S))return;
await Mu(this)}async Kd(k,U){if(this.S){var n=this.S;const C=n?.key?g.Zd(n.key).entityId:"";a:switch(k){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var Z=!1;break a;default:Z=!0}Z&&V3_(this)?(await jT(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),k=await ST(this,C),ki({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:C,y6:n,offlineModeType:k}),
C&&this.j&&await C3(C,this.j,this.B,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await Hwp(this,k),C&&this.j&&await C3(C,this.j,this.B,"DOWNLOAD_STATE_FAILED"))}else GR(this,`onTransferFailure: ${k}`);f3(this);n=Mu(this,!0);U&&U(n)}async VL(k){if(this.S)if(V3_(this)){await jT(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.S||GR(this,"onMaybeTransferStreamsExpiredRetryAttempting");var U=this.S,n=U?.key?g.Zd(U.key).entityId:"",Z=await ST(this,n);ki({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:n,y6:U,offlineModeType:Z});U=wW();g.jd(U,qu,{isEnqueuedForExpiredStreamUrlRefetch:!0});Z=g.Cd(n,"playbackData");n=XW(new u0("playbackData",n,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:Z,actionMetadata:U}));await g.$J(this.B,n,"offlineOrchestrationActionWrapperEntity")}else await Hwp(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.j&&(n=this.S,(n=n?.key?g.Zd(n.key).entityId:"")&&await C3(n,this.j,this.B,"DOWNLOAD_STATE_FAILED"));else GR(this,"onMaybeTransferStreamsExpired");
f3(this);n=Mu(this,!0);k&&k(n)}},ct={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var zlb=class{constructor(k,U){this.k$=k;this.api=U;this.L=new g.p$;this.W=new g.A6;this.iZ={zD:()=>this.j.iZ.zD(),
cU:()=>this.L,
W7E:()=>this.j,
jW:()=>this.jW(),
Sa:()=>this.Sa(),
zS:()=>this.zS(),
yP:()=>this.yP(),
AQ:()=>this.AQ(),
pM:n=>this.pM(n)};
this.j=new Exm(()=>RFs(this),()=>{this.zS()},this.api.qT(),this.api.C.bind(this.api));
this.S=new XPm(this.api);pIB(this.j)}jW(){return this.W.promise}Sa(){if(this.B&&this.X)return this.W.promise;zFm(this).then(this.W.resolve).catch(this.W.reject);return this.W.promise}V(k){return{playbackData:new An_(k,this.k$,this.S),transfer:new H1V(k,this.k$),videoPlaybackPositionEntity:new dw8(k,this.k$)}}async yP(){this.B&&await Owb(this.B)}async zS(){if(this.B||this.X)await this.jW(),this.dM!==void 0&&(g.j8(this.dM),this.dM=void 0),this.J!==void 0&&(g.j8(this.J),this.J=void 0),this.B?.dispose(),
this.B=void 0,this.X?.dispose(),this.X=void 0,g.LB(this.api,"onOrchestrationLostLeader"),this.W=new g.A6}isOrchestrationLeader(){return this.j.S}async x$(){return!1}MC(k){var U=this.S;U.api.publish("offlinetransferpause",k);U.B?.postMessage(k)}async ul(k){const U=await g.Nj();if(U){var n=g.Cd(k,"transfer");await g.ar(U,{mode:"readwrite",TQ:!0},Z=>{const C=I_(Z,n,"transfer"),r=I_(Z,g.Cd(k,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.Wi.all([C,r]).then(([L,F])=>L&&L.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(L.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",g.TT(Z,L,"transfer").then(()=>{ki({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:k,y6:L,offlineModeType:F?.offlineModeType});return g.Wi.resolve(null)})):g.Wi.resolve(null))})}}async SE(k=43200){if(!this.L.SB())return QTO();
var U=await g.Nj();if(!U)return[];const n=Date.now()/1E3;var Z=await D6(U,"offlineVideoPolicy");U=[];for(const C of Z)Number(C.lastUpdatedTimestampSeconds)+k<=n&&(Z=g.Zd(C.key).entityId,U.push(Z));return U.length?l0(this,U,this.Y,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return l0(this,["!*$_ALL_ENTITIES_!*$"],this.Y,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(k){return await this.SE(k)}setUpPositionSyncInterval(k){this.J!==
void 0&&(g.j8(this.J),this.J=void 0);const U=k??864E5;this.J=g.ok(()=>{this.pM(U)},U)}async pM(k){try{const U=await Bt.getInstance();
if(!U)throw Error("prefStorage is undefined");const n=await U.get("psi"),Z=n?.aX?Number(n.aX)/1E3:0,C=Date.now();Z+k<=C&&await l0(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(U){cD("Offline manager error",U)}}async AQ(){var k=await g.Nj();if(!k)return[];var U=await D6(k,"transfer");k=[];for(const n of U)n.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&n.key&&(U=g.Zd(n.key).entityId,k.push(U));return TR8(this,
k)}async D(){return[]}async Wy(){}async By(){}};var QnO=class extends Z${constructor(k,U,n){super(k);this.S=k;this.k$=U;this.j=n}B(k){return Up(k)?$Jm(this,k):n3(k)?NRY(this,k):Zl(k)?t3V(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},m9=[10];var KY2=class extends Z${constructor(k,U,n){super(k);this.S=k;this.k$=U;this.j=n}B(k){return Up(k)?sTp(this,k):n3(k)?Yv8(this,k):Zl(k)?DJE(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},PQb=[10];var TNV=class extends Z${constructor(k,U,n){super(k);this.S=k;this.k$=U;this.j=n}B(k){return n3(k)?jTi(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}};var a1V=class extends zlb{constructor(){super(...arguments);this.Y="mainVideoEntity"}V(k){const U=super.V(k);U.mainVideoEntity=new KY2(k,this.k$,this.S);U.mainPlaylistEntity=new QnO(k,this.k$,this.S);U.mainDownloadsListEntity=new TNV(k,this.k$,this.S);return U}async refreshAllStaleEntities(k,U){let n=[];this.k$.C("web_player_offline_playlist_auto_refresh")&&(n=await Sv7(this,k,U));var Z=await Bt.getInstance();const C=await Z?.get("sdois");Z=await Z?.get("lmqf");C&&(n=n.concat(await GrY(this,C,Z??
"SD",k===0)));return n=n.concat(await super.refreshAllStaleEntities(k,U))}async x$(k){var U=await g.Nj();if(!U)return!1;U=await Y7(U,g.CO,"mainDownloadsListEntity");if(U?.downloads?.length){k=g.Cd(k,"mainVideoEntity");for(const n of U.downloads)if(n.videoItem===k)return!0}return!1}async D(){var k=await g.Nj();if(!k)return[];var U=await D6(k,"downloadStatusEntity");k=[];for(const n of U)n.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&n.key&&(U=g.Zd(n.key).entityId,k.push(U));return k.length?l0(this,
k,"mainVideoEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async By(){const k=await g.Nj();k&&await g.ar(k,{mode:"readwrite",TQ:!0},U=>qm(U,"mainVideoEntity").then(n=>{const Z=[];for(const C of n){if(C.userState?.playbackPosition)continue;n=g.Zd(C.key).entityId;n={key:g.Cd(n,"videoPlaybackPositionEntity"),videoId:n,lastPlaybackPositionSeconds:"0"};Z.push(g.TT(U,n,"videoPlaybackPositionEntity"));C.userState={playbackPosition:n.key};
Z.push(g.TT(U,C,"mainVideoEntity"))}return g.Wi.all(Z)}))}async Wy(){const k=await g.Nj();
if(k){var U=g.Cd("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),n=await g.ar(k,{mode:"readonly",TQ:!0},u=>g.Wi.all([I_(u,U,"mainDownloadsListEntity"),I_(u,g.CO,"mainDownloadsListEntity"),qm(u,"mainVideoEntity"),qm(u,"mainPlaylistEntity")])),[Z,
C,r,L]=n;n=new Set;if(Z?.downloads?.length)for(var F of Z.downloads){var v=F.videoItem??F.playlistItem;v&&n.add(v)}if(C?.downloads?.length)for(var O of C.downloads)O.videoItem&&n.add(O.videoItem);F=new Set;O=[];for(var w of L){if(w.videos)for(const u of w.videos)(v=JSON.parse(g.Zd(u).entityId).videoId)&&F.add(v);w.key&&!n.has(w.key)&&O.push(w.key)}for(const u of r)u.key&&!n.has(u.key)&&(w=g.Zd(u.key).entityId,F.has(w)||O.push(u.key));O.length&&await hH(k,O)}}};var $w_=class extends Z${constructor(k,U){super(k);this.S=k;this.j=U}B(k){return Up(k)?M32(this,k):n3(k)?ybE(this,k):Zl(k)?cb7(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},i3=[10];var pP_=class extends Z${constructor(k,U){super(k);this.S=k;this.j=U}B(k){return Up(k)?xJp(this,k):n3(k)?k3b(this,k):Zl(k)?i1m(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},UA=[10];var NNE=class extends Z${constructor(k,U){super(k);this.S=k;this.j=U}B(k){return Up(k)?rnE(this,k):n3(k)?LYB(this,k):Zl(k)?FYV(this,k):Promise.reject(Error(`Unsupported action type: ${k.actionType}`))}},CWm=[10];var tL2=class extends zlb{constructor(){super(...arguments);this.Y="musicTrack"}V(k){const U=super.V(k);U.musicTrack=new NNE(k,this.S);U.musicPlaylist=new pP_(k,this.S);U.musicAlbumRelease=new $w_(k,this.S);return U}async refreshAllStaleEntities(k,U){let n=await O1m(this,k,U);return n=n.concat(await super.refreshAllStaleEntities(k,U))}};g.Jq("offline",class extends g.eX{constructor(){super(...arguments);this.events=new g.HW(this);this.k$=this.player.U();this.iZ={IH8:()=>this.S,
Hw:()=>this.Hw(),
Na:k=>this.Na(k)}}create(){g.K(this,this.events);
if(g.kD(this.k$))this.S=new a1V(this.k$,this.player);else if(g.mN(this.k$)||g.QC(this.k$))this.S=new tL2(this.k$,this.player);this.events.K(this.player,"onPlaybackStartExternal",()=>{this.Hw()});
this.events.K(this.player,"videodatachange",()=>{this.Hw()});
this.k$.C("html5_offline_playback_position_sync")&&this.events.K(this.player,"presentingplayerstatechange",this.Na)}VE(){return!1}async un(k,U,n,Z){return this.S?l0(this.S,k,U,n,Z):Promise.reject()}deleteAll(){return this.S.deleteAll()}SE(k){return this.S.SE(k)}refreshAllStaleEntities(k){return this.S.refreshAllStaleEntities(k)}setUpPositionSyncInterval(k){this.S.setUpPositionSyncInterval(k)}MC(k){this.S.MC(k)}ul(k){return this.S.ul(k)}async Hw(){const k=this.player.getVideoData();k.e5()&&wPY(k)&&
this.B!==k.clientPlaybackNonce&&await uS8(this,k)}async Na(k){var U=this.player.getVideoData();const n=U.xo;if(k.Mk(2)||k.Mk(512))(k=await g.Nj())?(U=U.videoId,await Y7(k,g.Cd(U,"mainVideoEntity"),"mainVideoEntity")&&await this.un([U],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(n).toString()}})):cD("PES is undefined")}isOrchestrationLeader(){return this.S.isOrchestrationLeader()}async updateDownloadState(k,
U){const n=await g.Nj();if(n){var {entityType:Z,entityId:C}=g.Zd(k);await C3(C,Z,n,U,!0)}else cD("PES is undefined")}});})(_yt_player);
